<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <title>å¼·åˆ¶ä¿®æ”¹å¯†ç¢¼ - å¸ƒå¡ç›¾</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
    <script src="/js/config.js"></script>
    <script src="/js/password-strength.js"></script> <!-- å¼•å…¥å¼·åº¦æ¢é‚è¼¯ -->
    <style>
        :root {
            --bg: #091218; --bg2: #0f2027; --accent: #00f6ff; --gold: #ffd700; --text: #eaf2f6; --muted: #a9bac6;
            --card: rgba(10, 22, 28, 0.55); --border: rgba(255, 255, 255, 0.14);
        }
        body {
            font-family: "Inter", system-ui, sans-serif;
            background: linear-gradient(135deg, #07161b, var(--bg2));
            color: var(--text);
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
        }
        .container {
            background: var(--card);
            padding: 40px;
            border-radius: 16px;
            border: 1px solid var(--border);
            box-shadow: 0 0 30px rgba(0, 0, 0, 0.5);
            width: 100%;
            max-width: 400px;
            text-align: center;
        }
        h2 { color: var(--gold); margin-bottom: 20px; }
        p { color: var(--muted); font-size: 14px; margin-bottom: 30px; }
        .form-group { margin-bottom: 20px; text-align: left; }
        label { display: block; margin-bottom: 8px; color: var(--muted); font-size: 13px; }

        /* è¼¸å…¥æ¡†å®¹å™¨ (å«çœ¼ç›æŒ‰éˆ•) */
        .input-wrapper { position: relative; }
        input {
            width: 100%; padding: 12px; padding-right: 40px; /* ç•™ç©ºé–“çµ¦çœ¼ç› */
            border-radius: 8px; border: 1px solid var(--border);
            background: var(--bg); color: var(--text); box-sizing: border-box;
        }
        .eye-btn {
            position: absolute; right: 10px; top: 50%; transform: translateY(-50%);
            background: none; border: none; cursor: pointer; color: var(--muted); font-size: 18px;
        }

        button.submit-btn {
            width: 100%; padding: 14px; background: var(--accent); color: var(--bg);
            border: none; border-radius: 8px; cursor: pointer; font-weight: bold; font-size: 16px;
            transition: 0.2s;
            margin-top: 10px;
        }
        button.submit-btn:hover { opacity: 0.9; }
        .error-msg { color: #ff5050; font-size: 13px; margin-top: 10px; display: none; }
    </style>
</head>
<body>
<div class="container" id="change-password-form">
    <h2>ğŸ”’ å®‰å…¨æç¤º</h2>
    <p>ç‚ºäº†æ‚¨çš„å¸³è™Ÿå®‰å…¨ï¼Œç³»çµ±åµæ¸¬åˆ°æ‚¨éœ€è¦é‡ç½®å¯†ç¢¼æ‰èƒ½ç¹¼çºŒä½¿ç”¨ã€‚</p>

    <div class="form-group">
        <label>ç›®å‰å¯†ç¢¼ (æˆ–è‡¨æ™‚å¯†ç¢¼)</label>
        <div class="input-wrapper">
            <input type="password" id="old-password" name="oldPassword" placeholder="è«‹è¼¸å…¥ç›®å‰å¯†ç¢¼">
            <button type="button" class="eye-btn" onclick="togglePasswordVisibility('old-password', this)">ğŸ‘</button>
        </div>
    </div>

    <div class="form-group">
        <label>æ–°å¯†ç¢¼</label>
        <div class="input-wrapper">
            <input type="password" id="new-password" name="newPassword" placeholder="è«‹è¼¸å…¥æ–°å¯†ç¢¼ (è‡³å°‘8ä½ï¼Œå«å¤§å°å¯«è‹±æ•¸)">
            <button type="button" class="eye-btn" onclick="togglePasswordVisibility('new-password', this)">ğŸ‘</button>
        </div>
        <!-- å¼·åº¦æ¢å®¹å™¨ -->
        <div id="strength-meter"></div>
    </div>

    <div class="form-group">
        <label>ç¢ºèªæ–°å¯†ç¢¼</label>
        <div class="input-wrapper">
            <input type="password" id="confirm-password" placeholder="è«‹å†æ¬¡è¼¸å…¥æ–°å¯†ç¢¼">
            <button type="button" class="eye-btn" onclick="togglePasswordVisibility('confirm-password', this)">ğŸ‘
            </button>
        </div>
    </div>

    <button class="submit-btn" onclick="changePassword()">ä¿®æ”¹å¯†ç¢¼ä¸¦ç™»å…¥</button>
    <div id="error-msg" class="error-msg"></div>
</div>

<script>
    // åˆå§‹åŒ–
    document.addEventListener('DOMContentLoaded', () => {
        const newPassInput = document.getElementById('new-password');
        const meterContainer = document.getElementById('strength-meter');

        // ç›£è½è¼¸å…¥ï¼Œæ›´æ–°å¼·åº¦æ¢
        newPassInput.addEventListener('input', () => {
            updateStrengthMeter(meterContainer, newPassInput.value);
        });

        // ç›£è½ Enter éµé€å‡º
        const inputs = document.querySelectorAll('input');
        inputs.forEach(input => {
            input.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') changePassword();
            });
        });
    });

    async function changePassword() {
        const oldPassword = document.getElementById('old-password').value;
        const newPassword = document.getElementById('new-password').value;
        const confirmPassword = document.getElementById('confirm-password').value;
        const errorEl = document.getElementById('error-msg');

        // éš±è—éŒ¯èª¤
        errorEl.style.display = 'none';
        window.clearFormErrors('change-password-form');

        if (!oldPassword || !newPassword || !confirmPassword) {
            showError('è«‹å¡«å¯«æ‰€æœ‰æ¬„ä½');
            return;
        }

        // å‰ç«¯å…ˆåšåŸºç¤æª¢æŸ¥ (å¾Œç«¯æœƒå†é©—ä¸€æ¬¡)
        if (calculatePasswordStrength(newPassword) < 3) { // è‡³å°‘è¦ 3 åˆ† (ä¸­)
             showError('æ–°å¯†ç¢¼å¼·åº¦ä¸è¶³ (éœ€å«å¤§å°å¯«è‹±æ–‡èˆ‡æ•¸å­—ï¼Œè‡³å°‘8ç¢¼)');
             return;
        }

        if (newPassword !== confirmPassword) {
            showError('å…©æ¬¡å¯†ç¢¼è¼¸å…¥ä¸ä¸€è‡´');
            return;
        }

        try {
            const token = window.getJwtToken();
            if (!token) {
                alert('ç™»å…¥ç‹€æ…‹å¤±æ•ˆï¼Œè«‹é‡æ–°ç™»å…¥');
                window.location.href = '/index.html';
                return;
            }

            // [Fix] ä½¿ç”¨ apiFetch (å·²åŒ…å« RFC 7807 é©é…)
            const response = await apiFetch(`${API_BASE_URL}/users/me/password`, {
                method: 'PATCH',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify({ oldPassword, newPassword })
            });

            const data = await response.json();

            if (response.ok && data.success) {
                alert('å¯†ç¢¼ä¿®æ”¹æˆåŠŸï¼è«‹ä½¿ç”¨æ–°å¯†ç¢¼é‡æ–°ç™»å…¥ã€‚');
                // æ¸…é™¤æ‰€æœ‰ç™»å…¥ç‹€æ…‹
                localStorage.removeItem('jwtToken');
                localStorage.removeItem('username');
                localStorage.removeItem('nickname');
                localStorage.removeItem('userRole');
                localStorage.removeItem('forcePasswordChange');

                // å°å›é¦–é  (ç™»å…¥é )
                window.location.href = '/index.html';
            } else {
                if (data.fieldErrors) {
                    window.showFormErrors('change-password-form', data.fieldErrors);
                    showError('è³‡æ–™æœ‰èª¤ï¼Œè«‹æª¢æŸ¥ç´…å­—æç¤º');
                } else {
                    showError(data.message || 'ä¿®æ”¹å¤±æ•—');
                }
            }
        } catch (error) {
            showError('ç¶²è·¯é€£ç·šç•°å¸¸');
        }
    }

    function showError(msg) {
        const el = document.getElementById('error-msg');
        el.textContent = msg;
        el.style.display = 'block';
    }
</script>
</body>
</html>
