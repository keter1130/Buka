<style>
    :root { --bg:#091218; --bg2:#0f2027; --accent:#00f6ff; --accent2:#00c9d4; --gold:#ffd700; --text:#eaf2f6; --muted:#a9bac6; --card:rgba(10,22,28,0.55); --border:rgba(255,255,255,0.14); }
</style>

<div class="content-card">
    <h3 style="color:var(--gold);">æ­¡è¿å›ä¾†ï¼Œ<span id="welcome-username">è®€å–ä¸­...</span></h3>
    <p class="muted">é€™æ˜¯æ‚¨çš„æœƒå“¡å„€è¡¨æ¿æ¦‚æ³ã€‚æ‚¨å¯ä»¥åœ¨é€™è£¡ä¸€è¦½æœ€æ–°çš„æœå‹™ç‹€æ…‹å’Œé‡è¦è³‡è¨Šã€‚</p>

    <div class="summary-grid"
         style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; margin-top: 30px;">

        <div class="card"
             style="padding: 20px; background-color: var(--card); border-radius: 8px; border-left: 5px solid var(--accent);">
            <h4>ğŸ›¡ï¸ æˆ‘çš„å¸ƒå¡ç›¾</h4>
            <p style="font-size: 2em; font-weight: 700; color: var(--accent);" id="shield-count">è¼‰å…¥ä¸­...</p>
            <p class="muted">æ‚¨ç›®å‰æŒæœ‰çš„å¸ƒå¡ç›¾æ•¸é‡ã€‚</p>
        </div>

        <div class="card"
             style="padding: 20px; background-color: var(--card); border-radius: 8px; border-left: 5px solid var(--gold);">
            <h4>ğŸ’° é»æ•¸é¤˜é¡</h4>
            <p style="font-size: 2em; font-weight: 700; color: var(--gold);" id="user-balance">è¼‰å…¥ä¸­...</p>
            <p class="muted">æ‚¨çš„å¯ç”¨é»æ•¸é¤˜é¡ã€‚</p>
        </div>

        <div class="card"
             style="padding: 20px; background-color: var(--card); border-radius: 8px; border-left: 5px solid var(--accent2);">
            <h4>ğŸ“‹ å¾…è™•ç†å·¥å–®</h4>
            <p style="font-size: 2em; font-weight: 700; color: var(--accent2);" id="pending-tickets">è¼‰å…¥ä¸­...</p>
            <p class="muted">æ‚¨çš„å®¢æœå·¥å–®ç‹€æ…‹ã€‚</p>
        </div>

    </div>

    <div style="margin-top: 30px; padding: 20px; background-color: var(--bg2); border-radius: 8px;">
        <h4 style="color: var(--accent);">ğŸ“¢ æœ€æ–°å…¬å‘Š</h4>
        <p>æ­¡è¿ä½¿ç”¨å¸ƒå¡ç›¾æœƒå“¡ç³»çµ±ï¼å¦‚æœ‰ä»»ä½•å•é¡Œï¼Œè«‹é€éã€Œå®¢æœå·¥å–®ã€èˆ‡æˆ‘å€‘è¯ç¹«ã€‚</p>
    </div>
</div>

<script>
    (function() {
        const API_BASE_URL = window.API_BASE_URL || (window.parent && window.parent.API_BASE_URL) || '';
        const CURRENT_JWT_TOKEN = localStorage.getItem('jwtToken') || '';
        const apiFetch = window.apiFetch || window.parent.apiFetch || fetch;

        const welcomeEl = document.getElementById('welcome-username');
        const username = localStorage.getItem('username');
        if (welcomeEl && username) {
            welcomeEl.textContent = username;
        }

        fetchUserBalance();
        fetchShieldCount();
        fetchPendingTickets();

        async function fetchUserBalance() {
            const balanceElement = document.getElementById('user-balance');
            try {
                const response = await apiFetch(`${API_BASE_URL}/points/balance`, {
                    headers: { 'Authorization': `Bearer ${CURRENT_JWT_TOKEN}` }
                });

                if (response.ok) {
                    const data = await response.json();
                    if (data.success) {
                        if (data.data && data.data.pointBalance !== undefined) {
                            const balance = parseFloat(data.data.pointBalance);
                            balanceElement.textContent = balance.toLocaleString() + ' é»';
                        } else {
                            balanceElement.textContent = '0 é»';
                        }
                    } else {
                        balanceElement.textContent = 'è®€å–å¤±æ•—';
                    }
                } else {
                    balanceElement.textContent = 'è®€å–å¤±æ•—';
                    balanceElement.style.color = '#ff3838';
                }
            } catch (error) {
                balanceElement.textContent = 'ç¶²è·¯éŒ¯èª¤';
                balanceElement.style.color = '#ff3838';
            }
        }

        async function fetchShieldCount() {
            const shieldElement = document.getElementById('shield-count');
            try {
                const response = await apiFetch(`${API_BASE_URL}/shields`, {
                    headers: { 'Authorization': `Bearer ${CURRENT_JWT_TOKEN}` }
                });

                if (response.ok) {
                    const data = await response.json();
                    if (data.success) {
                        // [Fix] æ­£ç¢ºè§£æ Page<ShieldResponse>
                        let count = 0;
                        if (data.data && Array.isArray(data.data.content)) {
                            count = data.data.totalElements; // ä½¿ç”¨ totalElements æ›´æº–ç¢º
                        } else if (Array.isArray(data.data)) {
                            count = data.data.length;
                        }
                        shieldElement.textContent = count + ' å€‹';
                        shieldElement.style.color = count > 0 ? 'var(--accent)' : 'var(--muted)';
                    } else {
                        shieldElement.textContent = '0 å€‹';
                    }
                } else {
                    shieldElement.textContent = 'è®€å–å¤±æ•—';
                    shieldElement.style.color = '#ff3838';
                }
            } catch (error) {
                shieldElement.textContent = 'ç¶²è·¯éŒ¯èª¤';
                shieldElement.style.color = '#ff3838';
            }
        }

        async function fetchPendingTickets() {
            const ticketElement = document.getElementById('pending-tickets');
            try {
                // [Optimization] ç‚ºäº†é¿å…æ‹‰å–æ‰€æœ‰å·¥å–®ï¼Œé€™è£¡åªæ‹‰å–ç¬¬ä¸€é ï¼Œä½†æˆ‘å€‘éœ€è¦çš„æ˜¯ç¸½æ•¸
                // æ›´å¥½çš„åšæ³•æ˜¯å¾Œç«¯æä¾›ä¸€å€‹çµ±è¨ˆ APIï¼Œä½†ç›®å‰å…ˆç”¨åˆ—è¡¨ API çš„ totalElements
                // é€™è£¡æˆ‘å€‘å‡è¨­æœªçµæ¡ˆçš„å·¥å–®ä¸æœƒå¤ªå¤šï¼Œæˆ–è€…æˆ‘å€‘åªé—œå¿ƒæ˜¯å¦æœ‰æœªçµæ¡ˆçš„
                const response = await apiFetch(`${API_BASE_URL}/tickets?size=100`, { // æ‹‰å– 100 ç­†ä»¥é€²è¡Œå‰ç«¯éæ¿¾
                    headers: { 'Authorization': `Bearer ${CURRENT_JWT_TOKEN}` }
                });

                if (response.ok) {
                    const data = await response.json();
                    if (data.success) {
                        let tickets = [];
                        // [Fix] æ­£ç¢ºè§£æ Page<TicketResponse>
                        if (data.data && Array.isArray(data.data.content)) {
                            tickets = data.data.content;
                        } else if (Array.isArray(data.data)) {
                            tickets = data.data;
                        }

                        const pending = tickets.filter(t => t.status !== 'CLOSED').length;
                        ticketElement.textContent = pending + ' å€‹';
                        ticketElement.style.color = pending > 0 ? 'var(--accent2)' : 'var(--muted)';
                    } else {
                        ticketElement.textContent = '0 å€‹';
                    }
                } else {
                    ticketElement.textContent = 'è®€å–å¤±æ•—';
                    ticketElement.style.color = '#ff3838';
                }
            } catch (error) {
                ticketElement.textContent = 'ç¶²è·¯éŒ¯èª¤';
                ticketElement.style.color = '#ff3838';
            }
        }
    })();
</script>
