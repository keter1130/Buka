<style>
    :root { --bg:#091218; --bg2:#0f2027; --accent:#00f6ff; --accent2:#00c9d4; --gold:#ffd700; --text:#eaf2f6; --muted:#a9bac6; --card:rgba(10,22,28,0.55); --border:rgba(255,255,255,0.14); }
    .shields-filters { display: flex; gap: 15px; margin-bottom: 25px; flex-wrap: wrap; align-items: center; }
    .search-box { flex: 1; min-width: 200px; padding: 12px 15px; background: var(--card); border: 1px solid var(--border); border-radius: 8px; color: var(--text); font-size: 14px; }
    .filter-select { padding: 12px 15px; background: var(--card); border: 1px solid var(--border); border-radius: 8px; color: var(--text); min-width: 150px; }
    .shields-table { width: 100%; border-collapse: collapse; }
    .shields-table th, .shields-table td { padding: 12px 15px; text-align: left; border-bottom: 1px solid var(--border); }
    .shields-table th { color: var(--muted); font-weight: 500; font-size: 12px; text-transform: uppercase; }
    .shields-table tr:hover { background: rgba(255,255,255,0.02); }
    .status-badge { padding: 4px 10px; border-radius: 12px; font-size: 12px; font-weight: 500; }
    .status-active { background: rgba(80,255,150,0.15); color: #50ff99; }
    .status-expired { background: rgba(255,80,80,0.15); color: #ff5050; }
    .status-suspended { background: rgba(255,180,50,0.15); color: #ffb432; }
    .member-link { color: var(--accent); cursor: pointer; text-decoration: underline; }
    .member-link:hover { color: var(--gold); }
    .filter-btn { padding: 8px 16px; border-radius: 20px; border: 1px solid var(--border); background: transparent; color: var(--text); cursor: pointer; transition: all 0.2s; }
    .filter-btn:hover { border-color: var(--accent); }
    .btn-sm { padding: 6px 12px; font-size: 12px; border-radius: 6px; cursor: pointer; }
    .btn-view { background: transparent; color: var(--accent); border: 1px solid var(--accent); }
    .btn-view:hover { background: var(--accent); color: var(--bg); }
    .empty-state { text-align: center; padding: 60px 20px; color: var(--muted); }
    .shield-detail-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 1000; display: none; overflow-y: auto; }
    .shield-detail-content { max-width: 700px; margin: 50px auto; padding: 30px; background: var(--bg2); border-radius: 16px; border: 1px solid var(--border); }
    .detail-section { margin-bottom: 20px; }
    .detail-section h4 { color: var(--gold); margin: 0 0 15px 0; font-size: 16px; }
    .detail-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; }
    .detail-item label { display: block; color: var(--muted); font-size: 12px; margin-bottom: 3px; }
    .detail-item span { font-size: 15px; }
    .stats-row { display: flex; gap: 20px; margin-bottom: 20px; }
    .stat-card { flex: 1; background: var(--card); border-radius: 12px; padding: 20px; text-align: center; border: 1px solid var(--border); }
    .stat-value { font-size: 28px; font-weight: 700; color: var(--accent); }
    .stat-label { color: var(--muted); font-size: 13px; margin-top: 5px; }
</style>

<div class="content-card">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px;">
        <h3 style="margin: 0;">布卡盾管理</h3>
    </div>

    <div class="stats-row" id="shields-stats">
        <div class="stat-card">
            <div class="stat-value" id="stat-total">0</div>
            <div class="stat-label">總數量</div>
        </div>
        <div class="stat-card">
            <div class="stat-value" id="stat-active">0</div>
            <div class="stat-label">啟用中</div>
        </div>
        <div class="stat-card">
            <div class="stat-value" id="stat-expired">0</div>
            <div class="stat-label">已到期</div>
        </div>
    </div>

    <div class="shields-filters">
        <input type="text" id="search-input" class="search-box" placeholder="搜尋盾編號、產品名稱、IP...">
        <select id="status-filter" class="filter-select">
            <option value="">全部狀態</option>
            <option value="ACTIVE">啟用中</option>
            <option value="EXPIRED">已到期</option>
            <option value="SUSPENDED">已暫停</option>
        </select>
        <button onclick="window.loadShields()" class="filter-btn" style="background: var(--accent); color: var(--bg); border-color: var(--accent);">篩選</button>
    </div>

    <div id="shields-container">
        <div style="text-align: center; padding: 40px;">
            <div class="loading-spinner" style="width: 40px; height: 40px; border: 3px solid var(--border); border-top-color: var(--accent); border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 15px;"></div>
            <p style="color: var(--muted);">載入中...</p>
        </div>
    </div>
</div>

<div id="shield-detail-modal" class="shield-detail-modal">
    <div class="shield-detail-content">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <h3 style="color: var(--gold); margin: 0;" id="detail-shield-no">布卡盾詳情</h3>
            <button onclick="window.closeShieldDetail()" style="background: none; border: none; color: var(--muted); font-size: 24px; cursor: pointer;">&times;</button>
        </div>
        <div id="shield-detail-body"></div>
    </div>
</div>

<div id="member-detail-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 1001; overflow-y: auto;">
    <div style="max-width: 550px; margin: 50px auto; padding: 25px; background: #0f2027; border-radius: 16px; border: 1px solid rgba(255,255,255,0.14);">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <h3 style="color: #ffd700; margin: 0;">會員詳情</h3>
            <button onclick="window.closeMemberDetailModal()" style="background: none; border: none; color: #a9bac6; font-size: 24px; cursor: pointer;">&times;</button>
        </div>
        <div id="member-detail-content"><p style="text-align: center; color: #a9bac6;">載入中...</p></div>
    </div>
</div>

<script>
(function() {
    let allShields = [];
    let pendingUserId = null;

    window.showMemberDetail = async function(userId) {
        const modal = document.getElementById('member-detail-modal');
        const content = document.getElementById('member-detail-content');
        modal.style.display = 'block';
        content.innerHTML = '<p style="text-align: center; color: #a9bac6;">載入中...</p>';
        
        try {
            const response = await fetch(`${API_BASE_URL}/admin/users/${userId}`, {
                headers: { 'Authorization': `Bearer ${CURRENT_JWT_TOKEN}` }
            });
            if (response.ok) {
                const data = await response.json();
                if (data.success) {
                    renderMemberDetail(data.data);
                } else {
                    content.innerHTML = '<p style="color: #ff5050; text-align: center;">載入失敗</p>';
                }
            } else {
                content.innerHTML = '<p style="color: #ff5050; text-align: center;">載入失敗</p>';
            }
        } catch (error) {
            content.innerHTML = '<p style="color: #ff5050; text-align: center;">網路錯誤</p>';
        }
    };
    
    function renderMemberDetail(user) {
        const content = document.getElementById('member-detail-content');
        const isActive = user.status === 'ACTIVE';
        const isAdmin = user.role === 'ADMIN';
        const adminBadge = isAdmin ? '<span style="background: rgba(255,215,0,0.2); color: #ffd700; padding: 2px 8px; border-radius: 10px; font-size: 11px; margin-left: 8px;">管理員</span>' : '';
        
        let actionButtonsHtml = '';
        if (isAdmin) {
            actionButtonsHtml = `
                <div style="display: flex; gap: 10px;">
                    <input type="number" id="adjust-points-input" placeholder="點數調整 (正/負)" style="flex: 1; padding: 10px; border-radius: 6px; border: 1px solid rgba(255,255,255,0.14); background: #091218; color: #eaf2f6;">
                    <button onclick="window.adjustMemberPoints(${user.id})" style="padding: 10px 20px; background: #00f6ff; color: #091218; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;">調整</button>
                </div>
                <p style="color: #a9bac6; font-size: 12px; margin-top: 10px;">管理員帳號無法停用或重設密碼</p>
            `;
        } else {
            actionButtonsHtml = `
                <div style="display: flex; gap: 10px;">
                    <input type="number" id="adjust-points-input" placeholder="點數調整 (正/負)" style="flex: 1; padding: 10px; border-radius: 6px; border: 1px solid rgba(255,255,255,0.14); background: #091218; color: #eaf2f6;">
                    <button onclick="window.adjustMemberPoints(${user.id})" style="padding: 10px 20px; background: #00f6ff; color: #091218; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;">調整</button>
                </div>
                <div style="display: flex; gap: 10px; margin-top: 10px;">
                    <button onclick="window.resetMemberPassword(${user.id})" style="flex: 1; padding: 8px 12px; background: transparent; border: 1px solid rgba(255,255,255,0.14); border-radius: 6px; color: #eaf2f6; cursor: pointer;">重設密碼</button>
                    <button onclick="window.toggleMemberStatus(${user.id}, ${isActive})" style="flex: 1; padding: 8px 12px; border: none; border-radius: 6px; cursor: pointer; ${isActive ? 'background: rgba(255,80,80,0.15); color: #ff5050;' : 'background: rgba(80,255,150,0.15); color: #50ff99;'}">${isActive ? '停用帳號' : '啟用帳號'}</button>
                </div>
            `;
        }
        
        content.innerHTML = `
            <div style="display: grid; gap: 12px;">
                <div style="display: flex; justify-content: space-between;"><span style="color: #a9bac6;">會員編號</span><span style="color: #ffd700; font-weight: 600;">${user.memberNo || '-'}${adminBadge}</span></div>
                <div style="display: flex; justify-content: space-between;"><span style="color: #a9bac6;">帳號</span><span style="color: #eaf2f6;">${user.username || '-'}</span></div>
                <div style="display: flex; justify-content: space-between;"><span style="color: #a9bac6;">電子郵件</span><span style="color: #eaf2f6;">${user.email || '-'}</span></div>
                <div style="display: flex; justify-content: space-between;"><span style="color: #a9bac6;">點數餘額</span><span style="color: #ffd700;">${parseFloat(user.pointBalance || 0).toLocaleString()} 點</span></div>
                <div style="display: flex; justify-content: space-between;"><span style="color: #a9bac6;">狀態</span><span style="${isActive ? 'color:#50ff99;' : 'color:#ff5050;'}">${isActive ? '啟用' : '停用'}</span></div>
                <div style="display: flex; justify-content: space-between;"><span style="color: #a9bac6;">註冊時間</span><span style="color: #eaf2f6;">${user.createdAt ? new Date(user.createdAt).toLocaleString('zh-TW') : '-'}</span></div>
            </div>
            <hr style="border: none; border-top: 1px solid rgba(255,255,255,0.14); margin: 20px 0;">
            <div>
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                    <h4 style="margin: 0; color: #00f6ff;">布卡盾</h4>
                </div>
                <div id="member-shields-list" style="color: #a9bac6; font-size: 14px;">載入中...</div>
            </div>
            <hr style="border: none; border-top: 1px solid rgba(255,255,255,0.14); margin: 20px 0;">
            <div style="display: grid; gap: 10px;">
                ${actionButtonsHtml}
            </div>
        `;
        
        loadMemberShieldsForDetail(user.id);
    }
    
    async function loadMemberShieldsForDetail(userId) {
        const container = document.getElementById('member-shields-list');
        try {
            const response = await fetch(`${API_BASE_URL}/admin/shields/user/${userId}`, {
                headers: { 'Authorization': `Bearer ${CURRENT_JWT_TOKEN}` }
            });
            if (response.ok) {
                const data = await response.json();
                if (data.success && data.data.length > 0) {
                    let html = '<div style="display: grid; gap: 8px;">';
                    data.data.slice(0, 3).forEach(shield => {
                        const statusClass = shield.status === 'ACTIVE' ? 'color:#50ff99;' : 'color:#ff5050;';
                        const statusText = shield.status === 'ACTIVE' ? '啟用' : '到期';
                        html += `<div style="display: flex; justify-content: space-between; padding: 8px; background: #091218; border-radius: 6px;">
                            <span style="color: #eaf2f6;">${shield.productName || shield.shieldNo || '-'}</span>
                            <span style="${statusClass}">${statusText}</span>
                        </div>`;
                    });
                    if (data.data.length > 3) {
                        html += `<p style="text-align: center; font-size: 12px; color: #a9bac6;">還有 ${data.data.length - 3} 個...</p>`;
                    }
                    html += '</div>';
                    container.innerHTML = html;
                } else {
                    container.innerHTML = '<p style="color: #a9bac6;">尚無布卡盾</p>';
                }
            }
        } catch (error) {
            container.innerHTML = '<p style="color: #ff5050;">載入失敗</p>';
        }
    }
    
    window.adjustMemberPoints = function(userId) {
        const amount = document.getElementById('adjust-points-input').value;
        if (!amount || isNaN(amount)) { alert('請輸入有效的點數'); return; }
        const description = prompt('請輸入調整原因：');
        if (!description) return;
        requireUnlock(async function() {
            try {
                const response = await fetch(`${API_BASE_URL}/admin/users/${userId}/adjust-points`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${CURRENT_JWT_TOKEN}`, 'Content-Type': 'application/json', 'X-Unlock-Token': getUnlockToken() },
                    body: JSON.stringify({ amount: parseFloat(amount), description })
                });
                const data = await response.json();
                if (data.success) { alert('點數調整成功'); window.closeMemberDetailModal(); window.loadShields(); }
                else { alert(data.message || '調整失敗'); }
            } catch (error) { alert('網路連線異常'); }
        });
    };
    
    window.resetMemberPassword = function(userId) {
        if (!confirm('確定要重設此會員的密碼嗎？')) return;
        requireUnlock(async function() {
            try {
                const response = await fetch(`${API_BASE_URL}/admin/users/${userId}/reset-password`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${CURRENT_JWT_TOKEN}`, 'X-Unlock-Token': getUnlockToken() }
                });
                const data = await response.json();
                if (data.success) {
                    const tempPassword = data.data?.tempPassword || data.tempPassword;
                    if (tempPassword) { alert(`密碼已重設成功！\n\n臨時密碼：${tempPassword}`); }
                    else { alert('密碼已重設，臨時密碼將發送至會員信箱'); }
                    window.closeMemberDetailModal();
                } else { alert(data.message || '重設失敗'); }
            } catch (error) { alert('網路連線異常'); }
        });
    };
    
    window.toggleMemberStatus = function(userId, currentlyActive) {
        const action = currentlyActive ? '停用' : '啟用';
        if (!confirm(`確定要${action}此會員嗎？`)) return;
        requireUnlock(async function() {
            try {
                const response = await fetch(`${API_BASE_URL}/admin/users/${userId}/toggle-status`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${CURRENT_JWT_TOKEN}`, 'X-Unlock-Token': getUnlockToken() }
                });
                const data = await response.json();
                if (data.success) { alert(`會員已${action}`); window.showMemberDetail(userId); }
                else { alert(data.message || `${action}失敗`); }
            } catch (error) { alert('網路連線異常'); }
        });
    };
    
    window.closeMemberDetailModal = function() {
        document.getElementById('member-detail-modal').style.display = 'none';
    };

    function checkPendingUserId() {
        const userId = sessionStorage.getItem('pendingShieldsUserId');
        const memberNo = sessionStorage.getItem('pendingShieldsMemberNo');
        if (userId) {
            sessionStorage.removeItem('pendingShieldsUserId');
            sessionStorage.removeItem('pendingShieldsMemberNo');
            pendingUserId = userId;
            if (memberNo) {
                document.getElementById('search-input').value = memberNo;
            }
            loadShieldsByUserId(userId);
        } else {
            window.loadShields();
        }
    }

    async function loadShieldsByUserId(userId) {
        const container = document.getElementById('shields-container');
        try {
            const response = await fetch(`${API_BASE_URL}/admin/shields/user/${userId}`, {
                headers: { 'Authorization': `Bearer ${CURRENT_JWT_TOKEN}` }
            });

            if (response.ok) {
                const data = await response.json();
                if (data.success) {
                    allShields = data.data;
                    if (allShields.length > 0 && allShields[0].user) {
                        document.getElementById('search-input').value = allShields[0].user.memberCode || '';
                    }
                    renderShields(allShields, '');
                    loadStats();
                }
            }
        } catch (error) {
            container.innerHTML = '<div class="empty-state"><p>載入失敗</p></div>';
        }
    }

    window.loadShields = async function() {
        const container = document.getElementById('shields-container');
        const keyword = document.getElementById('search-input').value.trim();
        const status = document.getElementById('status-filter').value;

        try {
            let url = `${API_BASE_URL}/admin/shields`;
            if (keyword) {
                url = `${API_BASE_URL}/admin/shields/search?keyword=${encodeURIComponent(keyword)}`;
            } else if (status) {
                url = `${API_BASE_URL}/admin/shields?status=${status}`;
            }

            const response = await fetch(url, {
                headers: { 'Authorization': `Bearer ${CURRENT_JWT_TOKEN}` }
            });

            if (response.ok) {
                const data = await response.json();
                if (data.success) {
                    allShields = data.data;
                    renderShields(allShields, status);
                }
            } else {
                container.innerHTML = '<div class="empty-state"><p>載入失敗</p></div>';
            }
        } catch (error) {
            container.innerHTML = '<div class="empty-state"><p>網路連線異常</p></div>';
        }
    };

    function renderShields(shields, statusFilter) {
        const container = document.getElementById('shields-container');
        
        let filtered = shields;
        if (statusFilter && !document.getElementById('search-input').value.trim()) {
            filtered = shields.filter(s => s.status === statusFilter);
        }

        if (filtered.length === 0) {
            container.innerHTML = '<div class="empty-state"><p>沒有符合條件的布卡盾</p></div>';
            return;
        }

        let html = `
            <table class="shields-table">
                <thead>
                    <tr>
                        <th>盾編號</th>
                        <th>產品</th>
                        <th>盾名稱</th>
                        <th>會員</th>
                        <th>狀態</th>
                        <th>到期日</th>
                        <th>操作</th>
                    </tr>
                </thead>
                <tbody>
        `;

        filtered.forEach(shield => {
            const expiresAt = shield.expiresAt ? new Date(shield.expiresAt).toLocaleDateString('zh-TW') : '-';
            const statusClass = shield.status === 'ACTIVE' ? 'status-active' : 
                               (shield.status === 'EXPIRED' ? 'status-expired' : 'status-suspended');
            const statusText = shield.status === 'ACTIVE' ? '啟用中' : 
                              (shield.status === 'EXPIRED' ? '已到期' : '已暫停');
            const memberCode = shield.user ? shield.user.memberCode : '-';
            const memberId = shield.user ? shield.user.id : null;
            const trialBadge = shield.isTrial ? '<span style="color: #ffb432; font-size: 11px;"> (試用)</span>' : '';

            html += `
                <tr>
                    <td style="font-family: monospace; color: var(--gold);">${shield.shieldNo || '-'}${trialBadge}</td>
                    <td>${shield.productName || '-'}</td>
                    <td style="color: var(--muted);">${shield.shieldName || '-'}</td>
                    <td>
                        ${memberId ? `<span class="member-link" onclick="window.showMemberDetail('${memberId}')">${shield.user.username || '-'} (${memberCode})</span>` : '-'}
                    </td>
                    <td><span class="status-badge ${statusClass}">${statusText}</span></td>
                    <td>${expiresAt}</td>
                    <td>
                        <button class="btn-sm btn-view" onclick="window.viewShieldDetail('${shield.id}')">詳情</button>
                        <button class="btn-sm btn-primary" onclick="window.openControlPanel('${shield.id}')" style="margin-left: 5px;">控制台</button>
                    </td>
                </tr>
            `;
        });

        html += '</tbody></table>';
        container.innerHTML = html;
    }

    window.goToMember = function(userId) {
        loadContent('admin/users');
        setTimeout(() => {
            const searchInput = document.querySelector('#search-input');
            if (searchInput && window.searchUsers) {
                window.searchUsers();
            }
        }, 300);
    };

    window.openControlPanel = async function(shieldId) {
        try {
            const response = await fetch(`${API_BASE_URL}/admin/shields/${shieldId}/sso-url`, {
                headers: { 'Authorization': `Bearer ${CURRENT_JWT_TOKEN}` }
            });
            
            if (response.ok) {
                const data = await response.json();
                if (data.success && data.data.ssoUrl) {
                    window.open(data.data.ssoUrl, '_blank');
                } else {
                    alert(data.message || '無法取得控制台連結');
                }
            } else {
                const data = await response.json();
                alert(data.message || '無法取得控制台連結');
            }
        } catch (error) {
            alert('取得控制台連結失敗');
        }
    };

    window.viewShieldDetail = async function(shieldId) {
        try {
            const response = await fetch(`${API_BASE_URL}/admin/shields/${shieldId}`, {
                headers: { 'Authorization': `Bearer ${CURRENT_JWT_TOKEN}` }
            });

            if (response.ok) {
                const data = await response.json();
                if (data.success) {
                    showShieldDetailModal(data.data);
                }
            }
        } catch (error) {
            alert('載入詳情失敗');
        }
    };

    function showShieldDetailModal(shield) {
        document.getElementById('detail-shield-no').textContent = shield.shieldNo || '布卡盾詳情';
        
        const expiresAt = shield.expiresAt ? new Date(shield.expiresAt).toLocaleDateString('zh-TW') : '-';
        const purchasedAt = shield.purchasedAt ? new Date(shield.purchasedAt).toLocaleDateString('zh-TW') : '-';
        const statusText = shield.status === 'ACTIVE' ? '啟用中' : 
                          (shield.status === 'EXPIRED' ? '已到期' : '已暫停');
        const trialText = shield.isTrial ? ' (試用版)' : '';

        let html = `
            <div class="detail-section">
                <h4>基本資訊</h4>
                <div class="detail-grid">
                    <div class="detail-item">
                        <label>盾編號</label>
                        <span style="color: var(--gold); font-family: monospace;">${shield.shieldNo || '-'}${trialText}</span>
                    </div>
                    <div class="detail-item">
                        <label>產品名稱</label>
                        <span>${shield.productName || '-'}</span>
                    </div>
                    <div class="detail-item">
                        <label>盾名稱</label>
                        <span>${shield.shieldName || '-'}</span>
                    </div>
                    <div class="detail-item">
                        <label>廠商實例 ID</label>
                        <span style="font-family: monospace;">${shield.vendorInstanceId || '-'}</span>
                    </div>
                </div>
            </div>

            <div class="detail-section">
                <h4>狀態資訊</h4>
                <div class="detail-grid">
                    <div class="detail-item">
                        <label>狀態</label>
                        <span>${statusText}</span>
                    </div>
                    <div class="detail-item">
                        <label>到期日</label>
                        <span>${expiresAt}</span>
                    </div>
                    <div class="detail-item">
                        <label>購買日期</label>
                        <span>${purchasedAt}</span>
                    </div>
                </div>
            </div>
        `;

        if (shield.user) {
            html += `
                <div class="detail-section">
                    <h4>所屬會員</h4>
                    <div class="detail-grid">
                        <div class="detail-item">
                            <label>會員編號</label>
                            <span class="member-link" onclick="window.goToMemberFromDetail('${shield.user.id}')">${shield.user.memberCode}</span>
                        </div>
                        <div class="detail-item">
                            <label>帳號</label>
                            <span>${shield.user.username}</span>
                        </div>
                        <div class="detail-item">
                            <label>電話</label>
                            <span>${shield.user.phone || '-'}</span>
                        </div>
                        <div class="detail-item">
                            <label>Email</label>
                            <span>${shield.user.email || '-'}</span>
                        </div>
                    </div>
                </div>
            `;
        }

        document.getElementById('shield-detail-body').innerHTML = html;
        document.getElementById('shield-detail-modal').style.display = 'block';
    }

    window.closeShieldDetail = function() {
        document.getElementById('shield-detail-modal').style.display = 'none';
    };

    window.goToMemberFromDetail = function(userId) {
        window.closeShieldDetail();
        window.goToMember(userId);
    };

    async function loadStats() {
        try {
            const response = await fetch(`${API_BASE_URL}/admin/shields`, {
                headers: { 'Authorization': `Bearer ${CURRENT_JWT_TOKEN}` }
            });
            if (response.ok) {
                const data = await response.json();
                if (data.success) {
                    const shields = data.data;
                    document.getElementById('stat-total').textContent = shields.length;
                    document.getElementById('stat-active').textContent = shields.filter(s => s.status === 'ACTIVE').length;
                    document.getElementById('stat-expired').textContent = shields.filter(s => s.status === 'EXPIRED').length;
                }
            }
        } catch (error) {
            console.error('Failed to load stats:', error);
        }
    }

    document.getElementById('search-input').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            window.loadShields();
        }
    });
    
    checkPendingUserId();
    loadStats();
})();
</script>
