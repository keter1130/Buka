<style>
    :root { --bg:#091218; --bg2:#0f2027; --accent:#00f6ff; --accent2:#00c9d4; --gold:#ffd700; --text:#eaf2f6; --muted:#a9bac6; --card:rgba(10,22,28,0.55); --border:rgba(255,255,255,0.14); }
    .logs-filters { display: flex; gap: 15px; margin-bottom: 25px; flex-wrap: wrap; align-items: center; }
    .filter-select { padding: 12px 15px; background: var(--card); border: 1px solid var(--border); border-radius: 8px; color: var(--text); min-width: 150px; }
    input[type="date"].filter-select { color-scheme: dark; appearance: auto; -webkit-appearance: auto; color: #eaf2f6 !important; background-color: rgba(10,22,28,0.55) !important; }
    input[type="date"].filter-select::-webkit-datetime-edit,
    input[type="date"].filter-select::-webkit-datetime-edit-fields-wrapper,
    input[type="date"].filter-select::-webkit-datetime-edit-text,
    input[type="date"].filter-select::-webkit-datetime-edit-month-field,
    input[type="date"].filter-select::-webkit-datetime-edit-day-field,
    input[type="date"].filter-select::-webkit-datetime-edit-year-field { color: #eaf2f6 !important; }
    input[type="date"].filter-select::-webkit-calendar-picker-indicator { filter: invert(1) brightness(100%) !important; cursor: pointer; opacity: 1 !important; width: 20px; height: 20px; }
    .logs-table { width: 100%; border-collapse: collapse; }
    .logs-table th, .logs-table td { padding: 12px 15px; text-align: left; border-bottom: 1px solid var(--border); }
    .logs-table th { color: var(--muted); font-weight: 500; font-size: 12px; text-transform: uppercase; }
    .logs-table tr:hover { background: rgba(255,255,255,0.02); }
    .type-badge { padding: 4px 10px; border-radius: 12px; font-size: 12px; font-weight: 500; }
    .type-buy { background: rgba(0,246,255,0.15); color: var(--accent); }
    .type-renew { background: rgba(80,255,150,0.15); color: #50ff99; }
    .type-upgrade { background: rgba(255,215,0,0.15); color: var(--gold); }
    .status-success { background: rgba(80,255,150,0.15); color: #50ff99; }
    .status-failed { background: rgba(255,80,80,0.15); color: #ff5050; }
    .status-pending { background: rgba(255,215,0,0.15); color: var(--gold); }
    .member-link { color: var(--accent); cursor: pointer; text-decoration: underline; }
    .filter-btn { padding: 8px 16px; border-radius: 20px; border: 1px solid var(--border); background: transparent; color: var(--text); cursor: pointer; transition: all 0.2s; }
    .filter-btn:hover { border-color: var(--accent); }
    .view-detail-btn { padding: 6px 12px; background: transparent; border: 1px solid var(--accent); border-radius: 6px; color: var(--accent); cursor: pointer; font-size: 12px; transition: all 0.2s; }
    .view-detail-btn:hover { background: var(--accent); color: var(--bg); }
    .empty-state { text-align: center; padding: 60px 20px; color: var(--muted); }
    .stats-row { display: flex; gap: 20px; margin-bottom: 20px; }
    .stat-card { flex: 1; background: var(--card); border-radius: 12px; padding: 20px; text-align: center; border: 1px solid var(--border); }
    .stat-value { font-size: 28px; font-weight: 700; color: var(--accent); }
    .stat-label { color: var(--muted); font-size: 13px; margin-top: 5px; }
    .pagination { display: flex; justify-content: center; align-items: center; gap: 10px; margin-top: 20px; flex-wrap: wrap; }
    .pagination button { padding: 8px 14px; border: 1px solid var(--border); background: var(--card); color: var(--text); border-radius: 6px; cursor: pointer; }
    .pagination button:disabled { opacity: 0.5; cursor: not-allowed; }
    .pagination button.active { background: var(--accent); color: var(--bg); border-color: var(--accent); }
    .pagination-info { color: var(--muted); font-size: 13px; }
    .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 1000; overflow-y: auto; }
    .modal-content { max-width: 700px; margin: 50px auto; padding: 30px; background: var(--bg2); border-radius: 16px; border: 1px solid var(--border); }
    .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
    .modal-close { font-size: 24px; cursor: pointer; color: var(--muted); }
    .modal-close:hover { color: var(--text); }
    .detail-row { display: flex; margin-bottom: 12px; }
    .detail-label { width: 120px; color: var(--muted); flex-shrink: 0; }
    .detail-value { flex: 1; color: var(--text); word-break: break-all; }
    .json-display { background: var(--bg); padding: 15px; border-radius: 8px; font-family: monospace; font-size: 13px; white-space: pre-wrap; word-break: break-all; max-height: 300px; overflow-y: auto; }
</style>

<div class="content-card">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px;">
        <h3 style="margin: 0;">API äº’å‹•æ—¥èªŒ</h3>
    </div>

    <div class="stats-row" id="logs-stats">
        <div class="stat-card">
            <div class="stat-value" id="stat-total">0</div>
            <div class="stat-label">ç¸½äº¤æ˜“æ•¸</div>
        </div>
        <div class="stat-card">
            <div class="stat-value" id="stat-success">0</div>
            <div class="stat-label">æˆåŠŸ</div>
        </div>
        <div class="stat-card">
            <div class="stat-value" id="stat-failed">0</div>
            <div class="stat-label">å¤±æ•—</div>
        </div>
    </div>

    <div class="logs-filters">
        <select id="type-filter" class="filter-select">
            <option value="">å…¨éƒ¨é¡å‹</option>
            <option value="BUY">è³¼è²·</option>
            <option value="RENEW">çºŒè²»</option>
            <option value="UPGRADE">å‡ç´š</option>
        </select>
        <select id="status-filter" class="filter-select">
            <option value="">å…¨éƒ¨ç‹€æ…‹</option>
            <option value="SUCCESS">æˆåŠŸ</option>
            <option value="FAILED">å¤±æ•—</option>
            <option value="PENDING">è™•ç†ä¸­</option>
        </select>
        <input type="date" id="start-date" class="filter-select" style="min-width: 130px;" data-enhance="calendar">
        <input type="date" id="end-date" class="filter-select" style="min-width: 130px;" data-enhance="calendar">
        <select id="page-size" class="filter-select" style="min-width: 80px;">
            <option value="20">20ç­†</option>
            <option value="50">50ç­†</option>
            <option value="100">100ç­†</option>
        </select>
        <button onclick="window.loadApiLogs()" class="filter-btn" style="background: var(--accent); color: var(--bg); border-color: var(--accent);">ç¯©é¸</button>
    </div>

    <div id="logs-container">
        <div style="text-align: center; padding: 40px;">
            <div class="loading-spinner" style="width: 40px; height: 40px; border: 3px solid var(--border); border-top-color: var(--accent); border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 15px;"></div>
            <p style="color: var(--muted);">è¼‰å…¥ä¸­...</p>
        </div>
    </div>
</div>

<div id="detail-modal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 id="detail-title">API è©³æƒ…</h3>
            <span class="modal-close" onclick="window.closeDetailModal()">&times;</span>
        </div>
        <div id="detail-content"></div>
    </div>
</div>

<div id="member-detail-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 1001; overflow-y: auto;">
    <div style="max-width: 550px; margin: 50px auto; padding: 25px; background: #0f2027; border-radius: 16px; border: 1px solid rgba(255,255,255,0.14);">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <h3 style="color: #ffd700; margin: 0;">æœƒå“¡è©³æƒ…</h3>
            <button onclick="window.closeMemberDetailModal()" style="background: none; border: none; color: #a9bac6; font-size: 24px; cursor: pointer;">&times;</button>
        </div>
        <div id="member-detail-content"><p style="text-align: center; color: #a9bac6;">è¼‰å…¥ä¸­...</p></div>
    </div>
</div>

<script>
(function() {
    let allLogs = [];
    let currentPage = 1;
    let pageSize = 20;

    window.showMemberDetail = async function(userId) {
        const modal = document.getElementById('member-detail-modal');
        const content = document.getElementById('member-detail-content');
        modal.style.display = 'block';
        content.innerHTML = '<p style="text-align: center; color: #a9bac6;">è¼‰å…¥ä¸­...</p>';
        
        try {
            const response = await apiFetch(`${API_BASE_URL}/admin/users/${userId}`, {
                headers: { 'Authorization': `Bearer ${CURRENT_JWT_TOKEN}` }
            });
            if (response.ok) {
                const data = await response.json();
                if (data.success) {
                    renderMemberDetail(data.data);
                } else {
                    content.innerHTML = '<p style="color: #ff5050; text-align: center;">è¼‰å…¥å¤±æ•—</p>';
                }
            } else {
                content.innerHTML = '<p style="color: #ff5050; text-align: center;">è¼‰å…¥å¤±æ•—</p>';
            }
        } catch (error) {
            content.innerHTML = '<p style="color: #ff5050; text-align: center;">ç¶²è·¯éŒ¯èª¤</p>';
        }
    };
    
    function renderMemberDetail(user) {
        const content = document.getElementById('member-detail-content');
        const isActive = user.status === 'ACTIVE';
        const isAdmin = user.role === 'ADMIN';
        const adminBadge = isAdmin ? '<span style="background: rgba(255,215,0,0.2); color: #ffd700; padding: 2px 8px; border-radius: 10px; font-size: 11px; margin-left: 8px;">ç®¡ç†å“¡</span>' : '';
        
        let actionButtonsHtml = '';
        if (isAdmin) {
            actionButtonsHtml = `
                <div style="display: flex; gap: 10px;">
                    <input type="number" id="adjust-points-input" placeholder="é»æ•¸èª¿æ•´ (æ­£/è² )" style="flex: 1; padding: 10px; border-radius: 6px; border: 1px solid rgba(255,255,255,0.14); background: #091218; color: #eaf2f6;">
                    <button onclick="window.adjustMemberPoints(${user.id})" style="padding: 10px 20px; background: #00f6ff; color: #091218; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;">èª¿æ•´</button>
                </div>
                <p style="color: #a9bac6; font-size: 12px; margin-top: 10px;">ç®¡ç†å“¡å¸³è™Ÿç„¡æ³•åœç”¨æˆ–é‡è¨­å¯†ç¢¼</p>
            `;
        } else {
            actionButtonsHtml = `
                <div style="display: flex; gap: 10px;">
                    <input type="number" id="adjust-points-input" placeholder="é»æ•¸èª¿æ•´ (æ­£/è² )" style="flex: 1; padding: 10px; border-radius: 6px; border: 1px solid rgba(255,255,255,0.14); background: #091218; color: #eaf2f6;">
                    <button onclick="window.adjustMemberPoints(${user.id})" style="padding: 10px 20px; background: #00f6ff; color: #091218; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;">èª¿æ•´</button>
                </div>
                <div style="display: flex; gap: 10px; margin-top: 10px;">
                    <button onclick="window.resetMemberPassword(${user.id})" style="flex: 1; padding: 8px 12px; background: transparent; border: 1px solid rgba(255,255,255,0.14); border-radius: 6px; color: #eaf2f6; cursor: pointer;">é‡è¨­å¯†ç¢¼</button>
                    <button onclick="window.toggleMemberStatus(${user.id}, ${isActive})" style="flex: 1; padding: 8px 12px; border: none; border-radius: 6px; cursor: pointer; ${isActive ? 'background: rgba(255,80,80,0.15); color: #ff5050;' : 'background: rgba(80,255,150,0.15); color: #50ff99;'}">${isActive ? 'åœç”¨å¸³è™Ÿ' : 'å•Ÿç”¨å¸³è™Ÿ'}</button>
                </div>
            `;
        }
        
        content.innerHTML = `
            <div style="display: grid; gap: 12px;">
                <div style="display: flex; justify-content: space-between;"><span style="color: #a9bac6;">æœƒå“¡ç·¨è™Ÿ</span><span style="color: #ffd700; font-weight: 600;">${user.memberNo || '-'}${adminBadge}</span></div>
                <div style="display: flex; justify-content: space-between;"><span style="color: #a9bac6;">å¸³è™Ÿ</span><span style="color: #eaf2f6;">${user.username || '-'}</span></div>
                <div style="display: flex; justify-content: space-between;"><span style="color: #a9bac6;">é›»å­éƒµä»¶</span><span style="color: #eaf2f6;">${user.email || '-'}</span></div>
                <div style="display: flex; justify-content: space-between;"><span style="color: #a9bac6;">é»æ•¸é¤˜é¡</span><span style="color: #ffd700;">${parseFloat(user.pointBalance || 0).toLocaleString()} é»</span></div>
                <div style="display: flex; justify-content: space-between;"><span style="color: #a9bac6;">ç‹€æ…‹</span><span style="${isActive ? 'color:#50ff99;' : 'color:#ff5050;'}">${isActive ? 'å•Ÿç”¨' : 'åœç”¨'}</span></div>
                <div style="display: flex; justify-content: space-between;"><span style="color: #a9bac6;">è¨»å†Šæ™‚é–“</span><span style="color: #eaf2f6;">${user.createdAt ? new Date(user.createdAt).toLocaleString('zh-TW') : '-'}</span></div>
            </div>
            <hr style="border: none; border-top: 1px solid rgba(255,255,255,0.14); margin: 20px 0;">
            <div>
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                    <h4 style="margin: 0; color: #00f6ff;">å¸ƒå¡ç›¾</h4>
                </div>
                <div id="member-shields-list" style="color: #a9bac6; font-size: 14px;">è¼‰å…¥ä¸­...</div>
            </div>
            <hr style="border: none; border-top: 1px solid rgba(255,255,255,0.14); margin: 20px 0;">
            <div style="display: grid; gap: 10px;">
                ${actionButtonsHtml}
            </div>
        `;
        
        loadMemberShields(user.id);
    }
    
    async function loadMemberShields(userId) {
        const container = document.getElementById('member-shields-list');
        try {
            const response = await apiFetch(`${API_BASE_URL}/admin/shields/user/${userId}`, {
                headers: { 'Authorization': `Bearer ${CURRENT_JWT_TOKEN}` }
            });
            if (response.ok) {
                const data = await response.json();
                if (data.success && data.data.length > 0) {
                    let html = '<div style="display: grid; gap: 8px;">';
                    data.data.slice(0, 3).forEach(shield => {
                        const statusClass = shield.status === 'ACTIVE' ? 'color:#50ff99;' : 'color:#ff5050;';
                        const statusText = shield.status === 'ACTIVE' ? 'å•Ÿç”¨' : 'åˆ°æœŸ';
                        html += `<div style="display: flex; justify-content: space-between; padding: 8px; background: #091218; border-radius: 6px;">
                            <span style="color: #eaf2f6;">${shield.productName || shield.shieldNo || '-'}</span>
                            <span style="${statusClass}">${statusText}</span>
                        </div>`;
                    });
                    if (data.data.length > 3) {
                        html += `<p style="text-align: center; font-size: 12px; color: #a9bac6;">é‚„æœ‰ ${data.data.length - 3} å€‹...</p>`;
                    }
                    html += '</div>';
                    container.innerHTML = html;
                } else {
                    container.innerHTML = '<p style="color: #a9bac6;">å°šç„¡å¸ƒå¡ç›¾</p>';
                }
            }
        } catch (error) {
            container.innerHTML = '<p style="color: #ff5050;">è¼‰å…¥å¤±æ•—</p>';
        }
    }
    
    window.adjustMemberPoints = function(userId) {
        const amount = document.getElementById('adjust-points-input').value;
        if (!amount || isNaN(amount)) { alert('è«‹è¼¸å…¥æœ‰æ•ˆçš„é»æ•¸'); return; }
        const description = prompt('è«‹è¼¸å…¥èª¿æ•´åŸå› ï¼š');
        if (!description) return;
        requireUnlock(async function() {
            try {
                const response = await apiFetch(`${API_BASE_URL}/admin/users/${userId}/adjust-points`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${CURRENT_JWT_TOKEN}`, 'Content-Type': 'application/json', 'X-Unlock-Token': getUnlockToken() },
                    body: JSON.stringify({ amount: parseFloat(amount), description })
                });
                const data = await response.json();
                if (data.success) { alert('é»æ•¸èª¿æ•´æˆåŠŸ'); window.closeMemberDetailModal(); window.loadApiLogs(); }
                else { alert(data.message || 'èª¿æ•´å¤±æ•—'); }
            } catch (error) { alert('ç¶²è·¯é€£ç·šç•°å¸¸'); }
        });
    };
    
    window.resetMemberPassword = function(userId) {
        if (!confirm('ç¢ºå®šè¦é‡è¨­æ­¤æœƒå“¡çš„å¯†ç¢¼å—ï¼Ÿ')) return;
        requireUnlock(async function() {
            try {
                const response = await apiFetch(`${API_BASE_URL}/admin/users/${userId}/reset-password`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${CURRENT_JWT_TOKEN}`, 'X-Unlock-Token': getUnlockToken() }
                });
                const data = await response.json();
                if (data.success) {
                    const tempPassword = data.data?.tempPassword || data.tempPassword;
                    if (tempPassword) { alert(`å¯†ç¢¼å·²é‡è¨­æˆåŠŸï¼\n\nè‡¨æ™‚å¯†ç¢¼ï¼š${tempPassword}`); }
                    else { alert('å¯†ç¢¼å·²é‡è¨­ï¼Œè‡¨æ™‚å¯†ç¢¼å°‡ç™¼é€è‡³æœƒå“¡ä¿¡ç®±'); }
                    window.closeMemberDetailModal();
                } else { alert(data.message || 'é‡è¨­å¤±æ•—'); }
            } catch (error) { alert('ç¶²è·¯é€£ç·šç•°å¸¸'); }
        });
    };
    
    window.toggleMemberStatus = function(userId, currentlyActive) {
        const action = currentlyActive ? 'åœç”¨' : 'å•Ÿç”¨';
        if (!confirm(`ç¢ºå®šè¦${action}æ­¤æœƒå“¡å—ï¼Ÿ`)) return;
        requireUnlock(async function() {
            try {
                const response = await apiFetch(`${API_BASE_URL}/admin/users/${userId}/toggle-status`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${CURRENT_JWT_TOKEN}`, 'X-Unlock-Token': getUnlockToken() }
                });
                const data = await response.json();
                if (data.success) { alert(`æœƒå“¡å·²${action}`); window.showMemberDetail(userId); }
                else { alert(data.message || `${action}å¤±æ•—`); }
            } catch (error) { alert('ç¶²è·¯é€£ç·šç•°å¸¸'); }
        });
    };
    
    window.closeMemberDetailModal = function() {
        document.getElementById('member-detail-modal').style.display = 'none';
    };

    initDefaultDates();

    function initDefaultDates() {
        const today = new Date();
        const thirtyDaysAgo = new Date();
        thirtyDaysAgo.setDate(today.getDate() - 30);
        
        const formatDate = (d) => {
            const year = d.getFullYear();
            const month = String(d.getMonth() + 1).padStart(2, '0');
            const day = String(d.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        };
        
        document.getElementById('start-date').value = formatDate(thirtyDaysAgo);
        document.getElementById('end-date').value = formatDate(today);
    }

    window.loadApiLogs = async function() {
        const container = document.getElementById('logs-container');
        container.innerHTML = `
            <div style="text-align: center; padding: 40px;">
                <div class="loading-spinner" style="width: 40px; height: 40px; border: 3px solid var(--border); border-top-color: var(--accent); border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 15px;"></div>
                <p style="color: var(--muted);">è¼‰å…¥ä¸­...</p>
            </div>
        `;

        try {
            const startDate = document.getElementById('start-date').value;
            const endDate = document.getElementById('end-date').value;
            
            let url = `${API_BASE_URL}/admin/api-logs`;
            if (startDate && endDate) {
                url += `?startDate=${startDate}&endDate=${endDate}`;
            }
            
            const response = await apiFetch(url, {
                headers: { 'Authorization': `Bearer ${CURRENT_JWT_TOKEN}` }
            });

            if (response.ok) {
                const data = await response.json();
                if (data.success) {
                    allLogs = data.data || [];
                    currentPage = 1;
                    updateStats();
                    applyFiltersAndRender();
                }
            } else {
                container.innerHTML = '<p style="color: #ff5050; text-align: center;">è¼‰å…¥å¤±æ•—</p>';
            }
        } catch (error) {
            container.innerHTML = '<p style="color: #ff5050; text-align: center;">è¼‰å…¥å¤±æ•—</p>';
        }
    };

    function updateStats() {
        document.getElementById('stat-total').textContent = allLogs.length;
        document.getElementById('stat-success').textContent = allLogs.filter(l => l.status === 'SUCCESS').length;
        document.getElementById('stat-failed').textContent = allLogs.filter(l => l.status === 'FAILED').length;
    }

    function applyFiltersAndRender() {
        const typeFilter = document.getElementById('type-filter').value;
        const statusFilter = document.getElementById('status-filter').value;
        pageSize = parseInt(document.getElementById('page-size').value) || 20;

        let filtered = allLogs;

        if (typeFilter) {
            filtered = filtered.filter(l => l.operationType === typeFilter);
        }
        if (statusFilter) {
            filtered = filtered.filter(l => l.status === statusFilter);
        }

        renderLogs(filtered);
    }

    function renderLogs(logs) {
        const container = document.getElementById('logs-container');

        if (!logs || logs.length === 0) {
            container.innerHTML = `
                <div class="empty-state">
                    <div style="font-size: 60px; margin-bottom: 15px;">ğŸ“‹</div>
                    <h4 style="color: var(--gold);">æš«ç„¡ API æ—¥èªŒ</h4>
                    <p>èª¿æ•´ç¯©é¸æ¢ä»¶æˆ–ç­‰å¾…æ–°çš„äº¤æ˜“ç´€éŒ„</p>
                </div>
            `;
            return;
        }

        const totalPages = Math.ceil(logs.length / pageSize);
        if (currentPage > totalPages) currentPage = totalPages;
        const startIdx = (currentPage - 1) * pageSize;
        const endIdx = startIdx + pageSize;
        const pageData = logs.slice(startIdx, endIdx);

        const typeLabels = { 'BUY': 'è³¼è²·', 'RENEW': 'çºŒè²»', 'UPGRADE': 'å‡ç´š' };
        const typeClasses = { 'BUY': 'type-buy', 'RENEW': 'type-renew', 'UPGRADE': 'type-upgrade' };
        const statusLabels = { 'SUCCESS': 'æˆåŠŸ', 'FAILED': 'å¤±æ•—', 'PENDING': 'è™•ç†ä¸­' };
        const statusClasses = { 'SUCCESS': 'status-success', 'FAILED': 'status-failed', 'PENDING': 'status-pending' };

        let html = `
            <table class="logs-table">
                <thead>
                    <tr>
                        <th>æ™‚é–“</th>
                        <th>äº¤æ˜“ç·¨è™Ÿ</th>
                        <th>æœƒå“¡</th>
                        <th>é¡å‹</th>
                        <th>ç”¢å“</th>
                        <th>é‡‘é¡</th>
                        <th>ç‹€æ…‹</th>
                        <th>æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody>
        `;

        pageData.forEach(log => {
            const time = new Date(log.purchasedAt).toLocaleString('zh-TW');
            const typeLabel = typeLabels[log.operationType] || log.operationType;
            const typeClass = typeClasses[log.operationType] || '';
            const statusLabel = statusLabels[log.status] || log.status;
            const statusClass = statusClasses[log.status] || '';

            html += `
                <tr>
                    <td style="white-space: nowrap;">${time}</td>
                    <td style="font-family: monospace; font-size: 12px;">${log.purchaseNo}</td>
                    <td>
                        <span class="member-link" onclick="window.showMemberDetail(${log.userId})">${log.username || '-'} (${log.memberNo || '-'})</span>
                    </td>
                    <td><span class="type-badge ${typeClass}">${typeLabel}</span></td>
                    <td>${log.productName || '-'}</td>
                    <td style="font-weight: 600;">${log.totalAmount} é»</td>
                    <td><span class="type-badge ${statusClass}">${statusLabel}</span></td>
                    <td><button class="view-detail-btn" onclick="window.showLogDetail(${log.id})">è©³æƒ…</button></td>
                </tr>
            `;
        });

        html += '</tbody></table>';

        if (totalPages > 1) {
            html += `<div class="pagination">`;
            html += `<button onclick="window.goToPage(1)" ${currentPage === 1 ? 'disabled' : ''}>é¦–é </button>`;
            html += `<button onclick="window.goToPage(${currentPage - 1})" ${currentPage === 1 ? 'disabled' : ''}>ä¸Šä¸€é </button>`;
            const startPage = Math.max(1, currentPage - 2);
            const endPage = Math.min(totalPages, currentPage + 2);
            for (let i = startPage; i <= endPage; i++) {
                html += `<button onclick="window.goToPage(${i})" class="${i === currentPage ? 'active' : ''}">${i}</button>`;
            }
            html += `<button onclick="window.goToPage(${currentPage + 1})" ${currentPage === totalPages ? 'disabled' : ''}>ä¸‹ä¸€é </button>`;
            html += `<button onclick="window.goToPage(${totalPages})" ${currentPage === totalPages ? 'disabled' : ''}>æœ«é </button>`;
            html += `<span class="pagination-info">å…± ${logs.length} ç­†ï¼Œç¬¬ ${currentPage}/${totalPages} é </span>`;
            html += `</div>`;
        } else if (logs.length > 0) {
            html += `<div class="pagination"><span class="pagination-info">å…± ${logs.length} ç­†</span></div>`;
        }

        container.innerHTML = html;
    }

    window.goToPage = function(page) {
        currentPage = page;
        applyFiltersAndRender();
    };

    window.showLogDetail = function(logId) {
        const log = allLogs.find(l => l.id === logId);
        if (!log) return;

        const typeLabels = { 'BUY': 'è³¼è²·', 'RENEW': 'çºŒè²»', 'UPGRADE': 'å‡ç´š' };
        const statusLabels = { 'SUCCESS': 'æˆåŠŸ', 'FAILED': 'å¤±æ•—', 'PENDING': 'è™•ç†ä¸­' };

        let vendorRequestDisplay = '<span style="color: var(--muted);">ç„¡è³‡æ–™</span>';
        if (log.vendorRequest) {
            try {
                const parsed = JSON.parse(log.vendorRequest);
                vendorRequestDisplay = `<div class="json-display">${JSON.stringify(parsed, null, 2)}</div>`;
            } catch (e) {
                vendorRequestDisplay = `<div class="json-display">${log.vendorRequest}</div>`;
            }
        }

        let vendorResponseDisplay = '<span style="color: var(--muted);">ç„¡è³‡æ–™</span>';
        if (log.vendorResponse) {
            try {
                const parsed = JSON.parse(log.vendorResponse);
                vendorResponseDisplay = `<div class="json-display">${JSON.stringify(parsed, null, 2)}</div>`;
            } catch (e) {
                vendorResponseDisplay = `<div class="json-display">${log.vendorResponse}</div>`;
            }
        }

        const content = `
            <div class="detail-row"><div class="detail-label">äº¤æ˜“ç·¨è™Ÿ</div><div class="detail-value" style="font-family: monospace;">${log.purchaseNo}</div></div>
            <div class="detail-row"><div class="detail-label">æ™‚é–“</div><div class="detail-value">${new Date(log.purchasedAt).toLocaleString('zh-TW')}</div></div>
            <div class="detail-row"><div class="detail-label">æœƒå“¡</div><div class="detail-value">${log.memberNo || '-'} (${log.username || '-'})</div></div>
            <div class="detail-row"><div class="detail-label">é¡å‹</div><div class="detail-value">${typeLabels[log.operationType] || log.operationType}</div></div>
            <div class="detail-row"><div class="detail-label">ç”¢å“</div><div class="detail-value">${log.productName || '-'}</div></div>
            <div class="detail-row"><div class="detail-label">æœˆæ•¸</div><div class="detail-value">${log.months} å€‹æœˆ</div></div>
            <div class="detail-row"><div class="detail-label">é‡‘é¡</div><div class="detail-value" style="font-weight: 600;">${log.totalAmount} é»</div></div>
            <div class="detail-row"><div class="detail-label">ç‹€æ…‹</div><div class="detail-value">${statusLabels[log.status] || log.status}</div></div>
            ${log.errorMessage ? `<div class="detail-row"><div class="detail-label">éŒ¯èª¤è¨Šæ¯</div><div class="detail-value" style="color: #ff5050;">${log.errorMessage}</div></div>` : ''}
            <div style="margin-top: 20px;">
                <div style="color: var(--accent); margin-bottom: 10px; font-weight: 600;">ç™¼å‡ºçš„è«‹æ±‚ (Request)ï¼š</div>
                ${vendorRequestDisplay}
            </div>
            <div style="margin-top: 20px;">
                <div style="color: var(--accent); margin-bottom: 10px; font-weight: 600;">æ”¶åˆ°çš„å›æ‡‰ (Response)ï¼š</div>
                ${vendorResponseDisplay}
            </div>
        `;

        document.getElementById('detail-title').textContent = `API è©³æƒ… - ${log.purchaseNo}`;
        document.getElementById('detail-content').innerHTML = content;
        document.getElementById('detail-modal').style.display = 'block';
    };

    window.closeDetailModal = function() {
        document.getElementById('detail-modal').style.display = 'none';
    };

    window.goToMemberDetail = function(userId) {
        if (typeof loadAdminContent === 'function') {
            sessionStorage.setItem('pendingMemberUserId', userId);
            loadAdminContent('users');
        }
    };

    document.getElementById('type-filter').addEventListener('change', applyFiltersAndRender);
    document.getElementById('status-filter').addEventListener('change', applyFiltersAndRender);
    document.getElementById('page-size').addEventListener('change', function() {
        currentPage = 1;
        applyFiltersAndRender();
    });

    document.getElementById('detail-modal').addEventListener('click', function(e) {
        if (e.target === this) {
            window.closeDetailModal();
        }
    });

    window.loadApiLogs();
})();
</script>
