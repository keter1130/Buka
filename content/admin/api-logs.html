<style>
    :root { --bg:#091218; --bg2:#0f2027; --accent:#00f6ff; --accent2:#00c9d4; --gold:#ffd700; --text:#eaf2f6; --muted:#a9bac6; --card:rgba(10,22,28,0.55); --border:rgba(255,255,255,0.14); }
    .logs-filters { display: flex; gap: 15px; margin-bottom: 25px; flex-wrap: wrap; align-items: center; }
    .filter-select { padding: 12px 15px; background: var(--card); border: 1px solid var(--border); border-radius: 8px; color: var(--text); min-width: 150px; }
    .filter-input { padding: 12px 15px; background: var(--card); border: 1px solid var(--border); border-radius: 8px; color: var(--text); min-width: 200px; }
    .logs-table { width: 100%; border-collapse: collapse; }
    .logs-table th, .logs-table td { padding: 12px 15px; text-align: left; border-bottom: 1px solid var(--border); }
    .logs-table th { color: var(--muted); font-weight: 500; font-size: 12px; text-transform: uppercase; }
    .logs-table tr:hover { background: rgba(255,255,255,0.02); }
    .status-badge { padding: 4px 10px; border-radius: 12px; font-size: 12px; font-weight: 500; }
    .status-200 { background: rgba(80,255,150,0.15); color: #50ff99; }
    .status-error { background: rgba(255,80,80,0.15); color: #ff5050; }
    .filter-btn { padding: 8px 16px; border-radius: 20px; border: 1px solid var(--border); background: transparent; color: var(--text); cursor: pointer; transition: all 0.2s; }
    .filter-btn:hover { border-color: var(--accent); }
    .view-detail-btn { padding: 6px 12px; background: transparent; border: 1px solid var(--accent); border-radius: 6px; color: var(--accent); cursor: pointer; font-size: 12px; transition: all 0.2s; }
    .view-detail-btn:hover { background: var(--accent); color: var(--bg); }
    .empty-state { text-align: center; padding: 60px 20px; color: var(--muted); }
    .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 1000; overflow-y: auto; }
    .modal-content { max-width: 800px; margin: 50px auto; padding: 30px; background: var(--bg2); border-radius: 16px; border: 1px solid var(--border); }
    .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
    .modal-close { font-size: 24px; cursor: pointer; color: var(--muted); }
    .modal-close:hover { color: var(--text); }
    .detail-row { display: flex; margin-bottom: 12px; }
    .detail-label { width: 120px; color: var(--muted); flex-shrink: 0; }
    .detail-value { flex: 1; color: var(--text); word-break: break-all; }
    .json-display { background: var(--bg); padding: 15px; border-radius: 8px; font-family: monospace; font-size: 13px; white-space: pre-wrap; word-break: break-all; max-height: 300px; overflow-y: auto; }
</style>

<div class="content-card">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px;">
        <h3 style="margin: 0;">API äº’å‹•æ—¥èªŒ</h3>
    </div>

    <div class="logs-filters">
        <select id="filter-provider" class="filter-select">
            <option value="">æ‰€æœ‰å» å•†</option>
            <option value="CLOUD_SHIELD">é›²ç›¾ (Cloud Shield)</option>
            <option value="TWILIO">Twilio</option>
            <option value="ECPAY">ç¶ ç•Œ (ECPay)</option>
            <option value="ALIYUN_CONSOLE">é˜¿é‡Œé›²æ§åˆ¶å°</option>
            <option value="OTHER">å…¶ä»–</option>
        </select>
        <select id="filter-category" class="filter-select">
            <option value="">æ‰€æœ‰é¡åˆ¥</option>
            <option value="PURCHASE">è³¼è²·/æ‰£æ¬¾</option>
            <option value="AUTH">é©—è­‰/ç™»å…¥</option>
            <option value="PROXY">ä»£ç†è½‰ç™¼</option>
            <option value="QUERY">æŸ¥è©¢</option>
            <option value="OTHER">å…¶ä»–</option>
        </select>
        <input type="text" id="filter-keyword" class="filter-input" placeholder="æœå°‹ URL / éŒ¯èª¤è¨Šæ¯ / å–®è™Ÿ...">
        <select id="page-size" class="filter-select" style="min-width: 80px;">
            <option value="20">20ç­†</option>
            <option value="50">50ç­†</option>
            <option value="100">100ç­†</option>
        </select>
        <button onclick="window.loadApiLogs(0)" class="filter-btn"
                style="background: var(--accent); color: var(--bg); border-color: var(--accent);">æœå°‹
        </button>
    </div>

    <div id="logs-container">
        <div style="text-align: center; padding: 40px;">
            <div class="loading-spinner"
                 style="width: 40px; height: 40px; border: 3px solid var(--border); border-top-color: var(--accent); border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 15px;"></div>
            <p style="color: var(--muted);">è¼‰å…¥ä¸­...</p>
        </div>
    </div>

    <!-- åˆ†é å®¹å™¨ -->
    <div id="pagination-container" class="mt-4"></div>
</div>

<div id="detail-modal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 id="detail-title">API è©³æƒ…</h3>
            <span class="modal-close" onclick="window.closeDetailModal()">&times;</span>
        </div>
        <div id="detail-content"></div>
    </div>
</div>

<script>
    (function() {
        let allLogs = [];
        let pageSize = 20;

        window.loadApiLogs = async function(page = 0) {
            const container = document.getElementById('logs-container');
            container.innerHTML = `
                <div style="text-align: center; padding: 40px;">
                    <div class="loading-spinner" style="width: 40px; height: 40px; border: 3px solid var(--border); border-top-color: var(--accent); border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 15px;"></div>
                    <p style="color: var(--muted);">è¼‰å…¥ä¸­...</p>
                </div>
            `;

            try {
                pageSize = parseInt(document.getElementById('page-size').value) || 20;
                const provider = document.getElementById('filter-provider').value;
                const category = document.getElementById('filter-category').value;
                const keyword = document.getElementById('filter-keyword').value;

                let url = `${API_BASE_URL}/admin/api-logs?page=${page}&size=${pageSize}`;
                if (provider) url += `&provider=${provider}`;
                if (category) url += `&category=${category}`;
                if (keyword) url += `&keyword=${encodeURIComponent(keyword)}`;

                const response = await apiFetch(url, {
                    headers: { 'Authorization': `Bearer ${CURRENT_JWT_TOKEN}` }
                });

                if (response.ok) {
                    const data = await response.json();
                    if (data.success) {
                        const pageData = data.data;
                        allLogs = pageData.content || [];
                        renderLogs(allLogs);

                        // [Fix] æ¸²æŸ“åˆ†é çµ„ä»¶
                        Pagination.render(pageData, 'pagination-container', window.loadApiLogs);
                    }
                } else {
                    container.innerHTML = '<p style="color: #ff5050; text-align: center;">è¼‰å…¥å¤±æ•—</p>';
                }
            } catch (error) {
                container.innerHTML = '<p style="color: #ff5050; text-align: center;">è¼‰å…¥å¤±æ•—</p>';
            }
        };

        function renderLogs(logs) {
            const container = document.getElementById('logs-container');

            if (!logs || logs.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div style="font-size: 60px; margin-bottom: 15px;">ğŸ“‹</div>
                        <h4 style="color: var(--gold);">æš«ç„¡ API æ—¥èªŒ</h4>
                        <p>ç›®å‰æ²’æœ‰ç¬¦åˆæ¢ä»¶çš„ API äº’å‹•ç´€éŒ„</p>
                    </div>
                `;
                return;
            }

            let html = `
                <table class="logs-table">
                    <thead>
                        <tr>
                            <th>æ™‚é–“</th>
                            <th>å» å•†</th>
                            <th>é¡åˆ¥</th>
                            <th>URL</th>
                            <th>Method</th>
                            <th>Status</th>
                            <th>è€—æ™‚</th>
                            <th>æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            logs.forEach(log => {
                const time = new Date(log.createdAt).toLocaleString('zh-TW');
                const statusClass = log.statusCode >= 200 && log.statusCode < 300 ? 'status-200' : 'status-error';
                const providerLabel = getProviderLabel(log.provider);
                const categoryLabel = getCategoryLabel(log.category);

                html += `
                    <tr>
                        <td style="white-space: nowrap;">${time}</td>
                        <td>${providerLabel}</td>
                        <td>${categoryLabel}</td>
                        <td style="font-family: monospace; font-size: 12px; max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${log.url || '-'}</td>
                        <td>${log.method}</td>
                        <td><span class="status-badge ${statusClass}">${log.statusCode}</span></td>
                        <td>${log.durationMs} ms</td>
                        <td><button class="view-detail-btn" onclick="window.showLogDetail(${log.id})">è©³æƒ…</button></td>
                    </tr>
                `;
            });

            html += '</tbody></table>';
            container.innerHTML = html;
        }

        function getProviderLabel(provider) {
            const map = {
                'CLOUD_SHIELD': 'é›²ç›¾',
                'TWILIO': 'Twilio',
                'ECPAY': 'ç¶ ç•Œ',
                'ALIYUN_CONSOLE': 'é˜¿é‡Œé›²',
                'OTHER': 'å…¶ä»–'
            };
            return map[provider] || provider;
        }

        function getCategoryLabel(category) {
            const map = {
                'PURCHASE': 'è³¼è²·',
                'AUTH': 'é©—è­‰',
                'PROXY': 'ä»£ç†',
                'QUERY': 'æŸ¥è©¢',
                'OTHER': 'å…¶ä»–'
            };
            return map[category] || category;
        }

        // [Fix] æ™ºæ…§å‹ JSON æ ¼å¼åŒ–å·¥å…·
        function formatJsonContent(content) {
            if (!content) return '<span style="color: var(--muted);">ç„¡è³‡æ–™</span>';

            try {
                // Case 1: å·²ç¶“æ˜¯ Object (æ–°è³‡æ–™)
                if (typeof content === 'object') {
                    return `<div class="json-display">${JSON.stringify(content, null, 2)}</div>`;
                }

                // Case 2: æ˜¯å­—ä¸²ï¼Œå˜—è©¦è§£æç‚º JSON (èˆŠè³‡æ–™)
                if (typeof content === 'string') {
                    // å˜—è©¦è§£æ
                    const parsed = JSON.parse(content);
                    return `<div class="json-display">${JSON.stringify(parsed, null, 2)}</div>`;
                }
            } catch (e) {
                // Case 3: è§£æå¤±æ•—ï¼Œç›´æ¥é¡¯ç¤ºåŸå§‹å­—ä¸²
                return `<div class="json-display">${content}</div>`;
            }

            // Fallback
            return `<div class="json-display">${content}</div>`;
        }

        window.showLogDetail = function(logId) {
            const log = allLogs.find(l => l.id === logId);
            if (!log) return;

            const requestHeadersDisplay = formatJsonContent(log.requestHeaders);
            const requestBodyDisplay = formatJsonContent(log.requestBody);
            const responseHeadersDisplay = formatJsonContent(log.responseHeaders);
            const responseBodyDisplay = formatJsonContent(log.responseBody);

            const content = `
                <div class="detail-row"><div class="detail-label">æ™‚é–“</div><div class="detail-value">${new Date(log.createdAt).toLocaleString('zh-TW')}</div></div>
                <div class="detail-row"><div class="detail-label">å» å•†</div><div class="detail-value">${getProviderLabel(log.provider)}</div></div>
                <div class="detail-row"><div class="detail-label">é¡åˆ¥</div><div class="detail-value">${getCategoryLabel(log.category)}</div></div>
                <div class="detail-row"><div class="detail-label">URL</div><div class="detail-value" style="font-family: monospace;">${log.url || '-'}</div></div>
                <div class="detail-row"><div class="detail-label">Method</div><div class="detail-value">${log.method}</div></div>
                <div class="detail-row"><div class="detail-label">Status Code</div><div class="detail-value" style="font-weight: 600;">${log.statusCode}</div></div>
                <div class="detail-row"><div class="detail-label">è€—æ™‚</div><div class="detail-value">${log.durationMs} ms</div></div>
                ${log.costAmount ? `<div class="detail-row"><div class="detail-label">é ä¼°è²»ç”¨</div><div class="detail-value">${log.costAmount}</div></div>` : ''}
                ${log.errorMessage ? `<div class="detail-row"><div class="detail-label" style="color:#ff5050;">éŒ¯èª¤è¨Šæ¯</div><div class="detail-value" style="color:#ff5050;">${log.errorMessage}</div></div>` : ''}

                <div style="margin-top: 20px;">
                    <div style="color: var(--accent); margin-bottom: 10px; font-weight: 600;">è«‹æ±‚æ¨™é ­ (Request Headers)ï¼š</div>
                    ${requestHeadersDisplay}
                </div>
                <div style="margin-top: 20px;">
                    <div style="color: var(--accent); margin-bottom: 10px; font-weight: 600;">è«‹æ±‚å…§å®¹ (Request Body)ï¼š</div>
                    ${requestBodyDisplay}
                </div>
                <div style="margin-top: 20px;">
                    <div style="color: var(--accent); margin-bottom: 10px; font-weight: 600;">å›æ‡‰æ¨™é ­ (Response Headers)ï¼š</div>
                    ${responseHeadersDisplay}
                </div>
                <div style="margin-top: 20px;">
                    <div style="color: var(--accent); margin-bottom: 10px; font-weight: 600;">å›æ‡‰å…§å®¹ (Response Body)ï¼š</div>
                    ${responseBodyDisplay}
                </div>
            `;

            document.getElementById('detail-title').textContent = `API è©³æƒ… - ID: ${log.id}`;
            document.getElementById('detail-content').innerHTML = content;
            document.getElementById('detail-modal').style.display = 'block';
        };

        window.closeDetailModal = function() {
            document.getElementById('detail-modal').style.display = 'none';
        };

        document.getElementById('page-size').addEventListener('change', function() {
            window.loadApiLogs(0);
        });

        document.getElementById('filter-provider').addEventListener('change', function() {
            window.loadApiLogs(0);
        });

        document.getElementById('filter-category').addEventListener('change', function() {
            window.loadApiLogs(0);
        });

        document.getElementById('filter-keyword').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                window.loadApiLogs(0);
            }
        });

        document.getElementById('detail-modal').addEventListener('click', function(e) {
            if (e.target === this) {
                window.closeDetailModal();
            }
        });

        window.loadApiLogs(0);
    })();
</script>
