<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <title>å¸ƒå¡ç›¾ - æœƒå“¡ä¸­å¿ƒ</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
    <script src="/js/config.js"></script>
    <script src="/js/datePickerEnhancer.js"></script>
    <style>
        /* æ²¿ç”¨ index.html çš„è¨­è¨ˆè®Šæ•¸ */
        :root{
          --bg:#091218; --bg2:#0f2027; --accent:#00f6ff; --accent2:#00c9d4; --gold:#ffd700; --text:#eaf2f6; --muted:#a9bac6;
          --card:rgba(10,22,28,0.55); --border:rgba(255,255,255,0.14); --glass: blur(14px);
          --nav:rgba(10,22,28,0.65);
        }
        *{box-sizing:border-box}
        html,body{margin:0; height:100%}
        body{
          font-family:"Inter","Segoe UI","Microsoft JhengHei",system-ui,sans-serif; color:var(--text);
          background-color: var(--bg2); /* è®“èƒŒæ™¯æ›´ç©©å®š */
          background-attachment:fixed;
        }

        /* ------------------------------ ä½ˆå±€æ¨£å¼ ------------------------------ */
        .dashboard-layout {
          display: flex;
          min-height: 100vh;
          max-width: 1400px; /* é™åˆ¶æœ€å¤§å¯¬åº¦ */
          margin: 0 auto;
        }

        /* å´é‚Šå°è¦½åˆ— (Sidebar) */
        .sidebar {
          width: 240px;
          flex-shrink: 0; /* ä¸è®“å®ƒè¢«å£“ç¸® */
          background-color: var(--bg);
          border-right: 1px solid var(--border);
          padding: 20px 0;
          box-shadow: 2px 0 10px rgba(0,0,0,0.3);
          position: sticky; /* è®“å´é‚Šæ¬„å›ºå®š */
          top: 0;
          height: 100vh;
          overflow-y: auto; /* è¶…å‡ºæ™‚å¯æ»¾å‹• */
        }

        .sidebar-header {
            padding: 0 20px 20px;
            color: var(--gold);
            font-size: 1.2em;
            font-weight: bold;
            border-bottom: 1px solid var(--border);
            margin-bottom: 20px;
        }

        .sidebar a {
          display: block;
          color: var(--text);
          text-decoration: none;
          padding: 12px 20px;
          margin: 4px 0;
          transition: background-color 0.2s, color 0.2s;
        }
        .sidebar a:hover {
          background-color: rgba(0, 246, 255, 0.08);
          color: var(--accent);
        }
        .sidebar a.active {
          background-color: var(--accent2);
          color: var(--bg);
          font-weight: bold;
          border-radius: 4px;
          margin: 4px 10px;
        }

        /* ä¸»è¦å…§å®¹å€ (Main Content) */
        .main-content {
          flex-grow: 1;
          padding: 30px;
        }

        .header-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--border);
        }

        #current-page-title {
          font-size: 2em;
          font-weight: 700;
          color: var(--accent);
        }

        #user-greeting {
            color: var(--text);
            font-weight: 500;
        }

        #user-greeting span {
            color: var(--gold);
            margin-right: 15px;
            font-weight: 700;
        }

        /* å‹•æ…‹è¼‰å…¥å…§å®¹å®¹å™¨ */
        #page-content {
          min-height: 600px; /* ç¢ºä¿å…§å®¹å€æœ‰æœ€å°é«˜åº¦ */
        }

        /* è¼‰å…¥å‹•ç•«æ¨£å¼ */
        .loading-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 80px 20px;
            color: var(--muted);
        }
        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 4px solid var(--border);
            border-top-color: var(--accent);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .loading-text {
            font-size: 1.1em;
            color: var(--muted);
        }
        
        .unread-badge {
            background: #ff5050;
            color: white;
            font-size: 11px;
            font-weight: 600;
            padding: 2px 6px;
            border-radius: 10px;
            margin-left: 6px;
            min-width: 18px;
            text-align: center;
        }

        /* éŒ¯èª¤ç‹€æ…‹æ¨£å¼ */
        .error-container {
            text-align: center;
            padding: 60px 20px;
            background: rgba(255, 80, 80, 0.08);
            border: 1px solid rgba(255, 80, 80, 0.3);
            border-radius: 12px;
        }
        .error-icon {
            font-size: 48px;
            margin-bottom: 15px;
        }
        .error-title {
            color: #ff6b6b;
            font-size: 1.3em;
            margin-bottom: 10px;
        }
        .error-message {
            color: var(--muted);
            margin-bottom: 20px;
        }
        .retry-btn {
            background: linear-gradient(135deg, rgba(0,246,255,.18), rgba(0,246,255,.06));
            border: 1px solid rgba(0,246,255,.4);
            color: var(--text);
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .retry-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(0,246,255,.2);
        }

        /* ------------------------------ æ‰‹æ©Ÿç‰ˆæ¨£å¼ ------------------------------ */
        @media (max-width: 768px) {
            .dashboard-layout {
                flex-direction: column;
            }

            .sidebar {
                width: 100%;
                height: auto;
                position: static;
                border-right: none;
                border-bottom: 1px solid var(--border);
                padding: 0;
            }

            .sidebar-header {
                display: none; /* æ‰‹æ©Ÿç‰ˆéš±è—æ¨™é¡Œ */
            }

            .sidebar-nav {
                 display: flex;
                 overflow-x: auto; /* å…è¨±å´é‚Šæ¬„æ©«å‘æ»¾å‹• */
                 padding: 0 10px;
                 white-space: nowrap;
                 margin-bottom: 10px;
                 border-bottom: 1px solid var(--border);
            }

            .sidebar a {
                flex-shrink: 0;
                padding: 10px 15px;
                margin: 0;
                border-radius: 0;
                text-align: center;
            }

            .sidebar a.active {
                margin: 0;
                border-radius: 0;
                border-bottom: 2px solid var(--accent);
                background-color: transparent;
                color: var(--accent);
            }

            .main-content {
                padding: 20px;
            }

            .header-bar {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }

            #user-greeting {
                order: -1; /* å°‡ç”¨æˆ¶å•å€™ç§»åˆ°æœ€ä¸Šé¢ */
            }

            #current-page-title {
                font-size: 1.5em;
            }
        }

        /* ------------------------------ å‹•æ…‹è¼‰å…¥å…§å®¹æ¨£å¼ (æ–¹ä¾¿å¿«é€Ÿé–‹ç™¼) ------------------------------ */
        /* é€™æ˜¯ç‚º content/xxx.html æª”æ¡ˆä¸­çš„å…§å®¹é è¨­çš„å®¹å™¨æ¨£å¼ */
        .content-card {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 8px 30px rgba(0,0,0,.45);
            backdrop-filter: var(--glass);
        }

        .content-card h3 {
            color: var(--accent);
            margin-top: 0;
            border-bottom: 1px solid var(--border);
            padding-bottom: 10px;
            margin-bottom: 15px;
            font-size: 1.5em;
        }

        /* æ—¥æœŸé¸æ“‡å™¨æ¨£å¼ - æ·±è‰²ä¸»é¡Œä¿®å¾© */
        input[type="date"] {
            appearance: auto !important;
            -webkit-appearance: auto !important;
            -moz-appearance: textfield !important;
            color-scheme: dark !important;
            color: var(--text) !important;
            background-color: var(--bg) !important;
        }
        input[type="date"]::-webkit-datetime-edit,
        input[type="date"]::-webkit-datetime-edit-fields-wrapper,
        input[type="date"]::-webkit-datetime-edit-text,
        input[type="date"]::-webkit-datetime-edit-month-field,
        input[type="date"]::-webkit-datetime-edit-day-field,
        input[type="date"]::-webkit-datetime-edit-year-field {
            color: var(--text) !important;
        }
        input[type="date"]::-webkit-calendar-picker-indicator {
            filter: invert(1) !important;
            cursor: pointer;
            opacity: 1 !important;
        }
    </style>
<script>
    window.showGlobalUserDetail = async function(userId) {
        const modal = document.getElementById('global-user-detail-modal');
        const content = document.getElementById('global-user-detail-content');
        if (!modal || !content) return;
        
        modal.style.display = 'block';
        content.innerHTML = '<p style="text-align: center; color: var(--muted);">è¼‰å…¥ä¸­...</p>';
        
        try {
            const token = localStorage.getItem('jwtToken');
            const response = await apiFetch(`${window.API_BASE_URL || ''}/admin/users/${userId}`, {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            
            if (response.ok) {
                const data = await response.json();
                if (data.success) {
                    const user = data.data;
                    content.innerHTML = `
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                            <div><label style="color: var(--muted); font-size: 12px;">å¸³è™Ÿ</label><p style="margin: 5px 0;">${user.username || '-'}</p></div>
                            <div><label style="color: var(--muted); font-size: 12px;">æœƒå“¡ç·¨è™Ÿ</label><p style="margin: 5px 0; color: var(--gold);">${user.memberNo || '-'}</p></div>
                            <div><label style="color: var(--muted); font-size: 12px;">æš±ç¨±</label><p style="margin: 5px 0;">${user.nickname || '-'}</p></div>
                            <div><label style="color: var(--muted); font-size: 12px;">Email</label><p style="margin: 5px 0;">${user.email || '-'}</p></div>
                            <div><label style="color: var(--muted); font-size: 12px;">é›»è©±</label><p style="margin: 5px 0;">${user.phone || '-'}</p></div>
                            <div><label style="color: var(--muted); font-size: 12px;">é»æ•¸é¤˜é¡</label><p style="margin: 5px 0; color: var(--accent);">${user.pointBalance || 0}</p></div>
                            <div><label style="color: var(--muted); font-size: 12px;">ç‹€æ…‹</label><p style="margin: 5px 0;">${user.enabled ? '<span style="color:#50ff99;">å•Ÿç”¨</span>' : '<span style="color:#ff5050;">åœç”¨</span>'}</p></div>
                            <div><label style="color: var(--muted); font-size: 12px;">è¨»å†Šæ™‚é–“</label><p style="margin: 5px 0;">${user.createdAt ? new Date(user.createdAt).toLocaleString('zh-TW') : '-'}</p></div>
                        </div>
                    `;
                } else {
                    content.innerHTML = '<p style="color: #ff5050; text-align: center;">è¼‰å…¥å¤±æ•—</p>';
                }
            } else {
                content.innerHTML = '<p style="color: #ff5050; text-align: center;">è¼‰å…¥å¤±æ•—</p>';
            }
        } catch (error) {
            content.innerHTML = '<p style="color: #ff5050; text-align: center;">ç¶²è·¯éŒ¯èª¤</p>';
        }
    };
    
    window.closeGlobalUserDetailModal = function() {
        const modal = document.getElementById('global-user-detail-modal');
        if (modal) modal.style.display = 'none';
    };
</script>
</head>

<body>
<div class="dashboard-layout">

    <aside class="sidebar">
        <div class="sidebar-header">å¸ƒå¡ç›¾ | æœƒå“¡ä¸­å¿ƒ</div>
        <div class="sidebar-nav" id="sidebar-nav">
            <a href="javascript:void(0)" onclick="loadContent('overview', 'ç³»çµ±æ¦‚æ³', this)" data-page="overview" class="active">æ¦‚æ³</a>
            <a href="javascript:void(0)" onclick="loadContent('instances', 'æˆ‘çš„å¸ƒå¡ç›¾', this)" data-page="instances">æˆ‘çš„å¸ƒå¡ç›¾</a>
            <a href="javascript:void(0)" onclick="loadContent('orders', 'æˆ‘çš„é»æ•¸', this)" data-page="orders">æˆ‘çš„é»æ•¸</a>
            <a href="javascript:void(0)" onclick="loadContent('tickets', 'å®¢æœå·¥å–®', this)" data-page="tickets">å®¢æœå·¥å–® <span id="unread-badge-user" class="unread-badge" style="display:none;"></span></a>
            <a href="javascript:void(0)" onclick="loadContent('account', 'æˆ‘çš„å¸³è™Ÿ', this)" data-page="account">æˆ‘çš„å¸³è™Ÿ</a>
        </div>
    </aside>

    <main class="main-content">
        <div class="header-bar">
            <h1 id="current-page-title">ç³»çµ±æ¦‚æ³</h1>
            <div id="user-greeting">
                <span></span>
                <button id="logout-btn" onclick="logoutUser()" style="
                background: none;
                border: 1px solid var(--border);
                color: var(--muted);
                cursor: pointer;
                padding: 6px 10px;
                border-radius: 6px;
                font-family: inherit;
                font-size: 0.9em;
                transition: background 0.2s;
            ">ç™»å‡º</button>
            </div>
        </div>

        <section id="page-content">
        </section>
    </main>
</div>

<!-- å…±ç”¨æœƒå“¡è©³æƒ… Modal (ç®¡ç†ç«¯ä½¿ç”¨) -->
<div id="global-user-detail-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 2000; overflow-y: auto;">
    <div style="max-width: 600px; margin: 50px auto; padding: 30px; background: var(--bg2); border-radius: 16px; border: 1px solid var(--border);">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px;">
            <h3 style="color: var(--gold); margin: 0;">æœƒå“¡è©³æƒ…</h3>
            <button onclick="window.closeGlobalUserDetailModal()" style="background: none; border: none; color: var(--muted); font-size: 24px; cursor: pointer;">&times;</button>
        </div>
        <div id="global-user-detail-content"></div>
    </div>
</div>

<script>
    const API_BASE_URL = window.API_BASE_URL || '';
    let CURRENT_JWT_TOKEN = localStorage.getItem('jwtToken');
    let CURRENT_USERNAME = localStorage.getItem('username');
    let CURRENT_NICKNAME = localStorage.getItem('nickname');
    let CURRENT_USER_ROLE = localStorage.getItem('userRole');
    let IS_ADMIN_VIEW = false;

    let FORCE_PASSWORD_CHANGE = false;

    document.addEventListener('DOMContentLoaded', () => {
        if (!CURRENT_JWT_TOKEN || !CURRENT_USERNAME) {
            alert('æ‚¨å°šæœªç™»å…¥ï¼Œè«‹å…ˆç™»å…¥ï¼');
            window.location.href = 'index.html';
            return;
        }

        const urlParams = new URLSearchParams(window.location.search);
        IS_ADMIN_VIEW = urlParams.get('admin') === 'true' && CURRENT_USER_ROLE === 'ADMIN';
        FORCE_PASSWORD_CHANGE = urlParams.get('forcePasswordChange') === 'true' || localStorage.getItem('forcePasswordChange') === 'true';

        const userGreetingSpan = document.querySelector('#user-greeting span');
        const displayName = CURRENT_NICKNAME || CURRENT_USERNAME;
        userGreetingSpan.textContent = `æ­¡è¿å›ä¾†, ${displayName}`;

        if (FORCE_PASSWORD_CHANGE) {
            handleForcePasswordChange();
            return;
        }

        if (IS_ADMIN_VIEW) {
            setupAdminNav();
            const targetPage = urlParams.get('page') || 'admin/dashboard';
            const pageLink = document.querySelector(`a[data-page="${targetPage}"]`) || document.querySelector('a[data-page="admin/dashboard"]');
            loadContent(targetPage, pageLink?.textContent || 'ç®¡ç†å¾Œå°', pageLink);
        } else {
            if (CURRENT_USER_ROLE === 'ADMIN') {
                addAdminEntryLink();
            }
            loadUnreadCount('user');
            const defaultLink = document.querySelector('a[data-page="overview"]');
            if (defaultLink) {
                loadContent('overview', 'ç³»çµ±æ¦‚æ³', defaultLink);
            }
        }
    });

    function handleForcePasswordChange() {
        const sidebarNav = document.getElementById('sidebar-nav');
        if (sidebarNav) {
            sidebarNav.querySelectorAll('a').forEach(a => {
                a.style.pointerEvents = 'none';
                a.style.opacity = '0.5';
            });
        }
        
        document.getElementById('current-page-title').textContent = 'ä¿®æ”¹å¯†ç¢¼';
        
        const pageContent = document.getElementById('page-content');
        pageContent.innerHTML = `
            <div class="content-card" style="max-width: 500px; margin: 0 auto;">
                <div style="background: rgba(255, 215, 0, 0.1); border: 1px solid var(--gold); padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                    <p style="color: var(--gold); margin: 0; text-align: center;">
                        <strong>é¦–æ¬¡ç™»å…¥æˆ–å¯†ç¢¼å·²è¢«é‡è¨­ï¼Œè«‹å…ˆä¿®æ”¹å¯†ç¢¼æ‰èƒ½ç¹¼çºŒä½¿ç”¨ç³»çµ±ã€‚</strong>
                    </p>
                </div>
                <h3 style="color:var(--gold); margin-bottom: 20px;">è¨­å®šæ–°å¯†ç¢¼</h3>
                <div style="margin-bottom: 15px;">
                    <label style="display: block; color: var(--muted); font-size: 13px; margin-bottom: 5px;">ç›®å‰å¯†ç¢¼ï¼ˆè‡¨æ™‚å¯†ç¢¼ï¼‰</label>
                    <input type="password" id="force-current-password" placeholder="è«‹è¼¸å…¥ç›®å‰å¯†ç¢¼" style="width: 100%; padding: 12px; border-radius: 8px; border: 1px solid var(--border); background: var(--bg); color: var(--text); box-sizing: border-box;">
                </div>
                <div style="margin-bottom: 15px;">
                    <label style="display: block; color: var(--muted); font-size: 13px; margin-bottom: 5px;">æ–°å¯†ç¢¼</label>
                    <input type="password" id="force-new-password" placeholder="è«‹è¼¸å…¥æ–°å¯†ç¢¼ (è‡³å°‘6å­—å…ƒ)" style="width: 100%; padding: 12px; border-radius: 8px; border: 1px solid var(--border); background: var(--bg); color: var(--text); box-sizing: border-box;">
                </div>
                <div style="margin-bottom: 20px;">
                    <label style="display: block; color: var(--muted); font-size: 13px; margin-bottom: 5px;">ç¢ºèªæ–°å¯†ç¢¼</label>
                    <input type="password" id="force-confirm-password" placeholder="è«‹å†æ¬¡è¼¸å…¥æ–°å¯†ç¢¼" style="width: 100%; padding: 12px; border-radius: 8px; border: 1px solid var(--border); background: var(--bg); color: var(--text); box-sizing: border-box;">
                </div>
                <button onclick="submitForcePasswordChange()" style="width: 100%; padding: 14px; background: var(--gold); color: var(--bg); border: none; border-radius: 8px; cursor: pointer; font-weight: bold; font-size: 16px;">ç¢ºèªä¿®æ”¹å¯†ç¢¼</button>
                <div id="force-password-message" style="margin-top: 15px; padding: 10px; border-radius: 6px; text-align: center; display: none;"></div>
            </div>
        `;
    }

    async function submitForcePasswordChange() {
        const currentPassword = document.getElementById('force-current-password').value;
        const newPassword = document.getElementById('force-new-password').value;
        const confirmPassword = document.getElementById('force-confirm-password').value;
        const msgEl = document.getElementById('force-password-message');

        function showMsg(msg, isSuccess) {
            msgEl.textContent = msg;
            msgEl.style.display = 'block';
            msgEl.style.backgroundColor = isSuccess ? 'rgba(0, 201, 212, 0.15)' : 'rgba(255, 80, 80, 0.15)';
            msgEl.style.color = isSuccess ? 'var(--accent)' : '#ff5050';
        }

        if (!currentPassword || !newPassword || !confirmPassword) {
            showMsg('è«‹å¡«å¯«æ‰€æœ‰æ¬„ä½', false);
            return;
        }
        if (newPassword.length < 6) {
            showMsg('æ–°å¯†ç¢¼è‡³å°‘éœ€è¦ 6 å€‹å­—å…ƒ', false);
            return;
        }
        if (newPassword !== confirmPassword) {
            showMsg('å…©æ¬¡è¼¸å…¥çš„æ–°å¯†ç¢¼ä¸ä¸€è‡´', false);
            return;
        }

        try {
            const response = await apiFetch(`${API_BASE_URL}/users/change-password`, {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${CURRENT_JWT_TOKEN}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ currentPassword, newPassword, confirmPassword })
            });

            const data = await response.json();

            if (response.ok && data.success) {
                showMsg('å¯†ç¢¼ä¿®æ”¹æˆåŠŸï¼æ­£åœ¨é‡æ–°å°å‘...', true);
                localStorage.removeItem('forcePasswordChange');
                setTimeout(() => {
                    if (CURRENT_USER_ROLE === 'ADMIN') {
                        window.location.href = 'dashboard.html?admin=true';
                    } else {
                        window.location.href = 'dashboard.html';
                    }
                }, 1500);
            } else {
                showMsg(data.message || 'å¯†ç¢¼ä¿®æ”¹å¤±æ•—', false);
            }
        } catch (error) {
            showMsg('ç¶²è·¯é€£ç·šç•°å¸¸', false);
        }
    }

    function addAdminEntryLink() {
        const sidebarNav = document.getElementById('sidebar-nav');
        if (sidebarNav) {
            const adminLink = document.createElement('a');
            adminLink.href = 'dashboard.html?admin=true';
            adminLink.innerHTML = 'é€²å…¥ç®¡ç†å¾Œå°';
            adminLink.style.cssText = 'border-top: 1px solid var(--border); margin-top: 20px; padding-top: 20px; color: var(--gold);';
            sidebarNav.appendChild(adminLink);
        }
    }

    function setupAdminNav() {
        const sidebarHeader = document.querySelector('.sidebar-header');
        const sidebarNav = document.getElementById('sidebar-nav');
        
        if (sidebarHeader) {
            sidebarHeader.textContent = 'å¸ƒå¡ç›¾ | ç®¡ç†å¾Œå°';
        }
        
        if (sidebarNav) {
            sidebarNav.innerHTML = `
                <a href="javascript:void(0)" onclick="loadContent('admin/dashboard', 'ç®¡ç†å“¡å„€è¡¨æ¿', this)" data-page="admin/dashboard" class="active">å„€è¡¨æ¿</a>
                <a href="javascript:void(0)" onclick="loadContent('admin/users', 'æœƒå“¡ç®¡ç†', this)" data-page="admin/users">æœƒå“¡ç®¡ç†</a>
                <a href="javascript:void(0)" onclick="loadContent('admin/shields', 'å¸ƒå¡ç›¾ç®¡ç†', this)" data-page="admin/shields">å¸ƒå¡ç›¾ç®¡ç†</a>
                <a href="javascript:void(0)" onclick="loadContent('admin/points', 'é»æ•¸ç´€éŒ„', this)" data-page="admin/points">é»æ•¸ç´€éŒ„</a>
                <a href="javascript:void(0)" onclick="loadContent('admin/tickets', 'å·¥å–®ç®¡ç†', this)" data-page="admin/tickets">å·¥å–®ç®¡ç† <span id="unread-badge-admin" class="unread-badge" style="display:none;"></span></a>
                <a href="javascript:void(0)" onclick="loadContent('admin/api-logs', 'API æ—¥èªŒ', this)" data-page="admin/api-logs">API æ—¥èªŒ</a>
                <a href="javascript:void(0)" onclick="loadContent('admin/api-test', 'API æ¸¬è©¦', this)" data-page="admin/api-test" style="color: var(--gold);">API æ¸¬è©¦</a>
                <a href="dashboard.html" style="border-top: 1px solid var(--border); margin-top: 20px; padding-top: 20px;">è¿”å›æœƒå“¡ä¸­å¿ƒ</a>
            `;
        }
        loadUnreadCount('admin');
    }
    
    async function loadUnreadCount(type) {
        try {
            const endpoint = type === 'admin' ? `${API_BASE_URL}/tickets/unread-count/admin` : `${API_BASE_URL}/tickets/unread-count`;
            const response = await apiFetch(endpoint, {
                headers: { 'Authorization': `Bearer ${CURRENT_JWT_TOKEN}` }
            });
            
            if (response.ok) {
                const data = await response.json();
                if (data.success) {
                    const count = data.data.unreadCount;
                    const badgeId = type === 'admin' ? 'unread-badge-admin' : 'unread-badge-user';
                    const badge = document.getElementById(badgeId);
                    if (badge) {
                        if (count > 0) {
                            badge.textContent = count > 99 ? '99+' : count;
                            badge.style.display = 'inline';
                        } else {
                            badge.style.display = 'none';
                        }
                    }
                }
            }
        } catch (error) {
            console.error('Failed to load unread count:', error);
        }
    }
    
    window.updateUnreadBadge = function() {
        const isAdmin = new URLSearchParams(window.location.search).get('admin') === 'true';
        loadUnreadCount(isAdmin ? 'admin' : 'user');
    };

    // ----------------------------------------------------------------------
    // ğŸ¯ è¼”åŠ©å‡½å¼ï¼šé¡¯ç¤ºè¼‰å…¥å‹•ç•«
    // ----------------------------------------------------------------------
    function showLoading(container, message = 'è³‡æ–™è¼‰å…¥ä¸­...') {
        container.innerHTML = `
            <div class="loading-container">
                <div class="loading-spinner"></div>
                <div class="loading-text">${message}</div>
            </div>
        `;
    }

    // ----------------------------------------------------------------------
    // ğŸ¯ è¼”åŠ©å‡½å¼ï¼šé¡¯ç¤ºéŒ¯èª¤ç‹€æ…‹ï¼ˆå«é‡è©¦æŒ‰éˆ•ï¼‰
    // ----------------------------------------------------------------------
    function showError(container, message, retryCallback) {
        container.innerHTML = `
            <div class="error-container">
                <div class="error-icon">âš ï¸</div>
                <div class="error-title">è¼‰å…¥å¤±æ•—</div>
                <div class="error-message">${message}</div>
                <button class="retry-btn" id="retry-btn">é‡æ–°è¼‰å…¥</button>
            </div>
        `;
        if (retryCallback) {
            document.getElementById('retry-btn').onclick = retryCallback;
        }
    }

    // ----------------------------------------------------------------------
    // ğŸ¯ æ ¸å¿ƒå‡½å¼ï¼šå‹•æ…‹è¼‰å…¥å…§å®¹ï¼ˆæ”¯æ´å¼·åˆ¶é‡æ–°è¼‰å…¥ï¼‰
    // ----------------------------------------------------------------------
    let currentLoadingPage = null;

    async function loadContent(pageName, titleText, currentLink) {
        const contentArea = document.getElementById('page-content');
        const pageTitle = document.getElementById('current-page-title');
        const navLinks = document.querySelectorAll('.sidebar a');

        if (!contentArea || !pageTitle) return;

        const url = `content/${pageName}.html`;
        const TIMEOUT_MS = 15000;

        pageTitle.textContent = titleText;
        currentLoadingPage = pageName;

        navLinks.forEach(link => link.classList.remove('active'));
        if (currentLink) {
            currentLink.classList.add('active');
        }

        showLoading(contentArea, 'é é¢è¼‰å…¥ä¸­...');

        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), TIMEOUT_MS);

        const retryFn = () => loadContent(pageName, titleText, currentLink);

        try {
            const response = await apiFetch(url + '?t=' + Date.now(), {
                signal: controller.signal,
                cache: 'no-store'
            });
            clearTimeout(timeoutId);

            if (!response.ok) {
                if (response.status === 404) {
                    showError(contentArea, `æ‰¾ä¸åˆ°é é¢: ${pageName}`, retryFn);
                } else {
                    throw new Error(`ä¼ºæœå™¨éŒ¯èª¤ (${response.status})`);
                }
                return;
            }

            const htmlContent = await response.text();
            contentArea.innerHTML = htmlContent;

            const scripts = contentArea.querySelectorAll('script');
            scripts.forEach(oldScript => {
                const newScript = document.createElement('script');
                newScript.textContent = oldScript.textContent;
                oldScript.parentNode.replaceChild(newScript, oldScript);
            });

            if (typeof window.enhanceDateInputs === 'function') {
                setTimeout(() => window.enhanceDateInputs(), 50);
                setTimeout(() => window.enhanceDateInputs(), 300);
                setTimeout(() => window.enhanceDateInputs(), 800);
            }

        } catch (error) {
            clearTimeout(timeoutId);
            console.error('è¼‰å…¥å…§å®¹å¤±æ•—:', error);

            if (error.name === 'AbortError') {
                showError(contentArea, 'è¼‰å…¥é€¾æ™‚ï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£ç·šå¾Œé‡è©¦ã€‚', retryFn);
            } else {
                showError(contentArea, `è¼‰å…¥å¤±æ•—ï¼š${error.message}`, retryFn);
            }
        }
    }

    // ----------------------------------------------------------------------
    // ğŸ¯ æ ¸å¿ƒå‡½å¼ï¼šç™»å‡º
    // ----------------------------------------------------------------------
    function logoutUser() {
        localStorage.removeItem('jwtToken');
        localStorage.removeItem('username');
        localStorage.removeItem('userRole');

        alert('å·²æˆåŠŸç™»å‡ºã€‚');
        window.location.href = 'index.html';
    }

    // ----------------------------------------------------------------------
    // ğŸ¯ å…±ç”¨æœƒå“¡è©³æƒ… Modal (ç®¡ç†ç«¯å„é é¢å¯å‘¼å«)
    // ----------------------------------------------------------------------
    window.showGlobalUserDetail = async function(userId) {
        const modal = document.getElementById('global-user-detail-modal');
        const content = document.getElementById('global-user-detail-content');
        
        content.innerHTML = '<p style="text-align: center; color: var(--muted);">è¼‰å…¥ä¸­...</p>';
        modal.style.display = 'block';

        try {
            const response = await apiFetch(`${API_BASE_URL}/admin/users/${userId}`, {
                headers: { 'Authorization': `Bearer ${CURRENT_JWT_TOKEN}` }
            });

            if (response.ok) {
                const data = await response.json();
                if (data.success) {
                    renderGlobalUserDetail(data.data);
                } else {
                    content.innerHTML = '<p style="color: #ff5050;">è¼‰å…¥å¤±æ•—</p>';
                }
            } else {
                content.innerHTML = '<p style="color: #ff5050;">è¼‰å…¥å¤±æ•—</p>';
            }
        } catch (error) {
            content.innerHTML = '<p style="color: #ff5050;">è¼‰å…¥å¤±æ•—</p>';
        }
    };

    window.closeGlobalUserDetailModal = function() {
        document.getElementById('global-user-detail-modal').style.display = 'none';
    };

    function renderGlobalUserDetail(user) {
        const content = document.getElementById('global-user-detail-content');
        const statusText = user.status === 'ACTIVE' ? 'æ­£å¸¸' : 'åœæ¬Š';
        const statusColor = user.status === 'ACTIVE' ? '#50ff99' : '#ff5050';
        const roleText = user.role === 'ADMIN' ? 'ç®¡ç†å“¡' : 'ä¸€èˆ¬æœƒå“¡';

        content.innerHTML = `
            <div style="display: grid; gap: 12px;">
                <div style="display: grid; grid-template-columns: 100px 1fr; gap: 8px; font-size: 14px;">
                    <span style="color: var(--muted);">æœƒå“¡ç·¨è™Ÿ</span>
                    <span style="color: var(--gold); font-family: monospace;">${user.memberNo || '-'}</span>
                    <span style="color: var(--muted);">å¸³è™Ÿ</span>
                    <span>${user.username}</span>
                    <span style="color: var(--muted);">æš±ç¨±</span>
                    <span>${user.nickname || '-'}</span>
                    <span style="color: var(--muted);">é›»å­éƒµä»¶</span>
                    <span>${user.email || '-'}</span>
                    <span style="color: var(--muted);">é›»è©±</span>
                    <span>${user.phone || '-'}</span>
                    <span style="color: var(--muted);">è§’è‰²</span>
                    <span>${roleText}</span>
                    <span style="color: var(--muted);">ç‹€æ…‹</span>
                    <span style="color: ${statusColor};">${statusText}</span>
                    <span style="color: var(--muted);">é»æ•¸é¤˜é¡</span>
                    <span style="color: var(--gold);">${user.pointBalance?.toLocaleString() || 0} é»</span>
                    <span style="color: var(--muted);">è¨»å†Šæ™‚é–“</span>
                    <span>${user.createdAt ? new Date(user.createdAt).toLocaleString('zh-TW') : '-'}</span>
                    <span style="color: var(--muted);">æœ€å¾Œç™»å…¥</span>
                    <span>${user.lastLoginAt ? new Date(user.lastLoginAt).toLocaleString('zh-TW') : '-'}</span>
                </div>
            </div>
        `;
    }

</script>
</body>
</html>